+function(d){var b=d.oc.foundation.base,a=b.prototype;var c=function(){b.call(this);this.init()};c.prototype=Object.create(a);c.prototype.constructor=c;c.prototype.init=function(){d(document).ready(this.proxy(this.registerHandlers))};c.prototype.updateTemplateList=function(g){var e=d("#cms-side-panel form[data-template-type="+g+"]"),f=g+"List";e.request(f+"::onUpdate",{complete:function(){d("button[data-control=delete-template]",e).trigger("oc.triggerOn.update")}})};c.prototype.registerHandlers=function(){var f=d(document),e=d("#cms-master-tabs");e.on("closed.oc.tab",this.proxy(this.onTabClosed));e.on("beforeClose.oc.tab",this.proxy(this.onBeforeTabClose));e.on("oc.beforeRequest",this.proxy(this.onBeforeRequest));e.on("shown.bs.tab",this.proxy(this.onTabShown));e.on("initTab.oc.tab",this.proxy(this.onInitTab));e.on("afterAllClosed.oc.tab",this.proxy(this.onAfterAllTabsClosed));d(window).on("ajaxInvalidField",this.proxy(this.ajaxInvalidField));f.on("open.oc.list","#cms-side-panel",this.proxy(this.onOpenDocument));f.on("ajaxUpdate","[data-control=filelist], [data-control=assetlist]",this.proxy(this.onAjaxUpdate));f.on("ajaxError","#cms-master-tabs form",this.proxy(this.onAjaxError));f.on("ajaxSuccess","#cms-master-tabs form",this.proxy(this.onAjaxSuccess));f.on("click","#cms-side-panel form button[data-control=create-template], #cms-side-panel form li a[data-control=create-template]",this.proxy(this.onCreateTemplateClick));f.on("click","#cms-side-panel form button[data-control=delete-template]",this.proxy(this.onDeleteTemplateClick));f.on("showing.oc.inspector","[data-inspectable]",this.proxy(this.onInspectorShowing));f.on("hidden.oc.inspector","[data-inspectable]",this.proxy(this.onInspectorHidden));f.on("hiding.oc.inspector","[data-inspectable]",this.proxy(this.onInspectorHiding));f.on("click","#cms-master-tabs > div.tab-content > .tab-pane.active .control-componentlist a.remove",this.proxy(this.onComponentRemove));f.on("click","#cms-component-list [data-component]",this.proxy(this.onComponentClick))};c.prototype.onOpenDocument=function(h){var f=d(h.relatedTarget),e=f.closest("[data-template-type]"),i={type:e.data("template-type"),theme:f.data("item-theme"),path:f.data("item-path")},g=i.type+"-"+i.theme+"-"+i.path;if(i.type=="asset"&&f.data("editable")===undefined){return true}if(e.length==0){return false}if(d("#cms-master-tabs").data("oc.tab").goTo(g)){return false}d.oc.stripeLoadIndicator.show();e.request("onOpenTemplate",{data:i}).done(function(j){d.oc.stripeLoadIndicator.hide();d("#cms-master-tabs").ocTab("addTab",j.tabTitle,j.tab,g,e.data("type-icon"))}).always(function(){d.oc.stripeLoadIndicator.hide()}).fail(function(j,l,k){alert(j.responseText.length?j.responseText:j.statusText);d.oc.stripeLoadIndicator.hide()});return false};c.prototype.ajaxInvalidField=function(j,i,e,g,h){if(!h){return}j.preventDefault();var n=d(i),m=n.closest(".form-tabless-fields.collapsed"),l=n.closest(".control-tabs.primary-tabs.collapsed");if(m.length>0){m.removeClass("collapsed")}if(l.length>0){l.removeClass("collapsed");var f=l.closest(".tab-pane"),k=d(".control-tabs.secondary-tabs",f);k.removeClass("primary-collapsed")}n.focus()};c.prototype.onTabClosed=function(e){this.updateModifiedCounter();if(d("> div.tab-content > div.tab-pane","#cms-master-tabs").length==0){this.setPageTitle("")}};c.prototype.onBeforeTabClose=function(e){if(d.fn.table!==undefined){d("[data-control=table]",e.relatedTarget).table("dispose")}d.oc.foundation.controlUtils.disposeControls(e.relatedTarget.get(0))};c.prototype.onBeforeRequest=function(f){var e=d(f.target);if(d(".components .layout-cell.error-component",e).length>0){if(!confirm("The form contains unknown components. Their properties will be lost on save. Do you want to save the form?")){f.preventDefault()}}};c.prototype.onTabShown=function(h){var e=d(h.target);if(e.closest("[data-control=tab]").attr("id")!="cms-master-tabs"){return}var g=e.closest("li").attr("data-tab-id"),i=e.attr("title"),f=d("#cms-side-panel");if(i){this.setPageTitle(i)}f.find("[data-control=filelist]").fileList("markActive",g);f.find("form").trigger("oc.list.setActiveItem",[g])};c.prototype.onInitTab=function(j,g){if(d(j.target).attr("id")!="cms-master-tabs"){return}var h=d('<a href="javascript:;" class="tab-collapse-icon tabless"><i class="icon-chevron-up"></i></a>'),o=d(".form-tabless-fields",g.pane);o.append(h);h.click(function(){o.toggleClass("collapsed");if(typeof(localStorage)!=="undefined"){localStorage.ocCmsTablessCollapsed=o.hasClass("collapsed")?1:0}window.setTimeout(function(){d(window).trigger("oc.updateUi")},500);return false});var e=d('<a href="javascript:;" class="tab-collapse-icon primary"><i class="icon-chevron-down"></i></a>'),l=d(".control-tabs.primary-tabs",g.pane),k=d(".control-tabs.secondary-tabs",g.pane),f=d(".nav-tabs",l);f.addClass("master-area");if(l.length>0){k.append(e);e.click(function(){l.toggleClass("collapsed");k.toggleClass("primary-collapsed");d(window).trigger("oc.updateUi");if(typeof(localStorage)!=="undefined"){localStorage.ocCmsPrimaryCollapsed=l.hasClass("collapsed")?1:0}return false})}if(typeof(localStorage)!=="undefined"){if(!d("a",g.tab).hasClass("new-template")&&localStorage.ocCmsTablessCollapsed==1){o.addClass("collapsed")}if(localStorage.ocCmsPrimaryCollapsed==1){l.addClass("collapsed");k.addClass("primary-collapsed")}}var i=d(".control-componentlist",g.pane).closest(".form-group");if(l.length>0){l.before(i)}else{k.parent().before(i)}i.removeClass();i.addClass("layout-row min-size");this.updateComponentListClass(g.pane);this.updateFormEditorMode(g.pane,true);var n=d("form",g.pane),m=this;n.on("changed.oc.changeMonitor",function(){o.trigger("modified.oc.tab");m.updateModifiedCounter()});n.on("unchanged.oc.changeMonitor",function(){o.trigger("unmodified.oc.tab");m.updateModifiedCounter()});this.addTokenExpanderToEditor(g.pane,n)};c.prototype.onAfterAllTabsClosed=function(f){var e=d("#cms-side-panel");e.find("[data-control=filelist]").fileList("markActive",null);e.find("form").trigger("oc.list.setActiveItem",[null])};c.prototype.onAjaxUpdate=function(g){var f=d("#cms-master-tabs .nav-tabs li.active").attr("data-tab-id"),e=d("#cms-side-panel");e.find("[data-control=filelist]").fileList("markActive",f);e.find("form").trigger("oc.list.setActiveItem",[f])};c.prototype.onAjaxSuccess=function(i,h,j){var g=i.target;if(j.templatePath!==undefined){d("input[name=templatePath]",g).val(j.templatePath);d("input[name=templateMtime]",g).val(j.templateMtime);d("[data-control=delete-button]",g).removeClass("hide");d("[data-control=preview-button]",g).removeClass("hide");if(j.pageUrl!==undefined){d("[data-control=preview-button]",g).attr("href",j.pageUrl)}}if(j.tabTitle!==undefined){d("#cms-master-tabs").ocTab("updateTitle",d(g).closest(".tab-pane"),j.tabTitle);this.setPageTitle(j.tabTitle)}var f=d("input[name=templateType]",g).val()+"-"+d("input[name=theme]",g).val()+"-"+d("input[name=templatePath]",g).val();d("#cms-master-tabs").ocTab("updateIdentifier",d(g).closest(".tab-pane"),f);var e=d("input[name=templateType]",g).val();if(e.length>0){d.oc.cmsPage.updateTemplateList(e);if(e=="layout"){this.updateLayouts(g)}}this.updateFormEditorMode(d(g).closest(".tab-pane"),false);if(h.handler=="onSave"&&(!j.X_OCTOBER_ERROR_FIELDS&&!j.X_OCTOBER_ERROR_MESSAGE)){d(g).trigger("unchange.oc.changeMonitor")}};c.prototype.onAjaxError=function(g,e,h,f){if(e.handler=="onSave"){if(f.responseText=="mtime-mismatch"){g.preventDefault();this.handleMtimeMismatch(g.target)}}};c.prototype.onCreateTemplateClick=function(i){var f=d(i.target).closest("[data-template-type]"),h=f.data("template-type"),g=h+Math.random(),e=this;d.oc.stripeLoadIndicator.show();f.request("onCreateTemplate",{data:{type:h}}).done(function(j){d("#cms-master-tabs").ocTab("addTab",j.tabTitle,j.tab,g,f.data("type-icon")+" new-template");d("#layout-side-panel").trigger("close.oc.sidePanel");e.setPageTitle(j.tabTitle)}).always(function(){d.oc.stripeLoadIndicator.hide()})};c.prototype.onDeleteTemplateClick=function(i){var h=d(i.currentTarget),f=h.closest("form"),g=f.data("template-type"),e=this;if(!confirm(h.data("confirmation"))){return}d.oc.stripeLoadIndicator.show();f.request("onDeleteTemplates",{data:{type:g}}).done(function(k){var j=d("#cms-master-tabs").data("oc.tab");d.each(k.deleted,function(m,o){var l=g+"-"+k.theme+"-"+o,n=j.findByIdentifier(l);d("#cms-master-tabs").ocTab("closeTab",n,true)});if(k.error!==undefined&&d.type(k.error)==="string"&&k.error.length){d.oc.flashMsg({text:k.error,"class":"error"})}}).always(function(){e.updateTemplateList(g);d.oc.stripeLoadIndicator.hide()})};c.prototype.onInspectorShowing=function(e,f){d(e.currentTarget).closest('[data-control="toolbar"]').data("oc.dragScroll").goToElement(e.currentTarget,f.callback);e.stopPropagation()};c.prototype.onInspectorHidden=function(g){var f=g.target,e=d.parseJSON(d("[data-inspector-values]",f).val());d('[name="component_aliases[]"]',f).val(e["oc.alias"]);d("span.alias",f).text(e["oc.alias"])};c.prototype.onInspectorHiding=function(i,f){var h=i.target,f=d.parseJSON(d("[data-inspector-values]",h).val()),g=f["oc.alias"],e=d("#cms-master-tabs > div.tab-content > .tab-pane.active .control-componentlist .layout"),j=d(i.target).parent();d("div.layout-cell",e).each(function(){if(j.get(0)==this){return true}var k=d('input[name="component_aliases[]"]',this);if(k.val()==g){i.preventDefault();alert('The component alias "'+g+'" is already used.');return false}})};c.prototype.onComponentRemove=function(j){var h=j.currentTarget;d(h).trigger("change");var k=d(h).closest(".tab-pane"),f=d(h).closest("div.layout-cell");var i=d("[data-control=codeeditor]",k);if(i.length){var g=d('input[name="component_aliases[]"]',f).val(),e=i.codeEditor("getEditorObject");e.replace("",{needle:"{% component '"+g+"' %}"})}f.remove();d(window).trigger("oc.updateUi");this.updateComponentListClass(k);return false};c.prototype.onComponentClick=function(r){var i=d("#cms-master-tabs > div.tab-content > .tab-pane.active .control-componentlist .layout");if(i.length==0){alert("Components can be added only to pages, partials and layouts.");return}var n=d(r.currentTarget).clone(),g=n.find("[data-component-icon]"),m=d(".layout-relative",n),f=n.find("[data-inspector-config]"),o=n.find("[data-component-default-alias]"),h=n.find("[data-inspector-values]"),p=n.find("[data-component-name]"),q=n.find("[data-inspector-class]"),l=o.val(),k=l,e=2,j=[];d('div.layout-cell input[name="component_aliases[]"]',i).each(function(){j.push(d(this).val())});while(d.inArray(l,j)!==-1){l=k+e;e++}d('input[name="component_aliases[]"]',d(r.currentTarget)).val(l);n.attr("data-component-attached",true);m.addClass(g.val());g.remove();m.attr({"data-inspectable":"","data-inspector-title":n.find("span.name").text(),"data-inspector-description":n.find("span.description").text(),"data-inspector-config":f.val(),"data-inspector-class":q.val()});f.remove();d('input[name="component_names[]"]',n).val(p.val());p.remove();d('input[name="component_aliases[]"]',n).val(l);n.find("span.alias").text(l);h.val(h.val().replace("--alias--",l));o.remove();n.addClass("adding");i.append(n);i.closest('[data-control="toolbar"]').data("oc.dragScroll").goToElement(n);n.removeClass("adding");n.trigger("change");this.updateComponentListClass(n.closest(".tab-pane"));d(window).trigger("oc.updateUi")};c.prototype.updateComponentListClass=function(i){var f=d(".control-componentlist",i),h=d(".control-tabs.primary-tabs",i),g=d(".nav-tabs",h),e=d(".layout",f).children(":not(.hidden)").length>0;g.toggleClass("component-area",e);f.toggleClass("has-components",e)};c.prototype.updateFormEditorMode=function(f,l){var n=d("[data-toolbar-type]",f);if(n.length==0){return}if(n.data("toolbar-type")!="content"){return}var g=d("input[name=fileName]",f).val(),h=g.split("."),m="txt",i="plain_text",e=d.oc.codeEditorExtensionModes,j=d("[data-control=codeeditor]",f);if(h.length>=2){m=h.pop().toLowerCase()}if(e[m]!==undefined){i=e[m]}var k=function(){window.setTimeout(function(){j.data("oc.codeEditor").editor.getSession().setMode({path:"ace/mode/"+i})},200)};if(l){j.on("oc.codeEditorReady",k)}else{k()}};c.prototype.updateModifiedCounter=function(){var e={page:{menu:"pages",count:0},partial:{menu:"partials",count:0},layout:{menu:"layouts",count:0},content:{menu:"content",count:0},asset:{menu:"assets",count:0}};d("> div.tab-content > div.tab-pane[data-modified]","#cms-master-tabs").each(function(){var f=d("> form > input[name=templateType]",this).val();e[f].count++});d.each(e,function(f,g){d.oc.sideNav.setCounter("cms/"+g.menu,g.count)})};c.prototype.addTokenExpanderToEditor=function(l,h){var k=d("[data-field-name=markup]",l),i=d("[data-control=codeeditor]",k),e=false,g=this;if(!i.length||i.data("oc.tokenexpander")){return}var j=i.codeEditor("getToolbar");i.tokenExpander();var f=d("<li />").prop({"class":"tokenexpander-button"}).append(d("<a />").prop({href:"javascript:; "}).append(d("<i />").prop({"class":"icon-code-fork"})));f.hide().on("click",function(){g.handleExpandToken(i,h);return false});d("ul:first",j).prepend(f);i.on("show.oc.tokenexpander",function(){e=true;f.show()}).on("hide.oc.tokenexpander",function(){e=false;f.hide()}).on("dblclick",function(m){if((m.metaKey||m.ctrlKey)&&e){g.handleExpandToken(i,h)}})};c.prototype.handleExpandToken=function(f,e){f.tokenExpander("expandToken",function(g,h){return e.request("onExpandMarkupToken",{data:{tokenType:g,tokenName:h}})})};c.prototype.handleMtimeMismatch=function(h){var g=d(h);g.popup({handler:"onOpenConcurrencyResolveForm"});var e=g.data("oc.popup"),f=this;d(e.$content).on("click","button[data-action=reload]",function(){e.hide();f.reloadForm(h)});d(e.$content).on("click","button[data-action=save]",function(){e.hide();d("input[name=templateForceSave]",g).val(1);d("a[data-request=onSave]",g).trigger("click");d("input[name=templateForceSave]",g).val(0)})};c.prototype.reloadForm=function(j){var f=d(j),k={type:d("[name=templateType]",f).val(),theme:d("[name=theme]",f).val(),path:d("[name=templatePath]",f).val(),},g=k.type+"-"+k.theme+"-"+k.path,h=d("#cms-master-tabs").data("oc.tab"),i=h.findByIdentifier(g),e=this;d.oc.stripeLoadIndicator.show();f.request("onOpenTemplate",{data:k}).done(function(l){d("#cms-master-tabs").ocTab("updateTab",i,l.tabTitle,l.tab);d("#cms-master-tabs").ocTab("unmodifyTab",i);e.updateModifiedCounter()}).always(function(){d.oc.stripeLoadIndicator.hide()}).fail(function(l,n,m){alert(l.responseText.length?l.responseText:l.statusText)})};c.prototype.setPageTitle=function(e){if(e.length){d.oc.layout.setPageTitle(e+" | ")}else{d.oc.layout.setPageTitle(e)}};c.prototype.updateLayouts=function(e){d(e).request("onGetTemplateList",{success:function(f){d('#cms-master-tabs > .tab-content select[name="settings[layout]"]').each(function(){var g=d(this),h=g.val();g.find("option").remove();d.each(f.layouts,function(j,i){g.append(d("<option>").attr("value",j).text(i))});g.trigger("pause.oc.changeMonitor");g.val(h);g.trigger("change");g.trigger("resume.oc.changeMonitor")})}})};d.oc.cmsPage=new c()}(window.jQuery);