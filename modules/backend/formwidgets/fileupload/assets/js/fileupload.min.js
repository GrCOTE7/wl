+function(e){var d=e.oc.foundation.base,c=d.prototype;var a=function(g,f){this.$el=e(g);this.options=f||{};e.oc.foundation.controlUtils.markDisposable(g);d.call(this);this.init()};a.prototype=Object.create(c);a.prototype.constructor=a;a.prototype.init=function(){if(this.options.isMulti===null){this.options.isMulti=this.$el.hasClass("is-multi")}if(this.options.isPreview===null){this.options.isPreview=this.$el.hasClass("is-preview")}if(this.options.isSortable===null){this.options.isSortable=this.$el.hasClass("is-sortable")}this.$el.one("dispose-control",this.proxy(this.dispose));this.$uploadButton=e(".upload-button",this.$el);this.$filesContainer=e(".upload-files-container",this.$el);this.uploaderOptions={};this.$el.on("click",".upload-object.is-success",this.proxy(this.onClickSuccessObject));this.$el.on("click",".upload-object.is-error",this.proxy(this.onClickErrorObject));if(this.options.isPreview){return}this.$el.on("click",".upload-remove-button",this.proxy(this.onRemoveObject));this.bindUploader();if(this.options.isSortable){this.bindSortable()}};a.prototype.dispose=function(){this.$el.off("click",".upload-object.is-success",this.proxy(this.onClickSuccessObject));this.$el.off("click",".upload-object.is-error",this.proxy(this.onClickErrorObject));this.$el.off("click",".upload-remove-button",this.proxy(this.onRemoveObject));this.$el.off("dispose-control",this.proxy(this.dispose));this.$el.removeData("oc.fileUpload");this.$el=null;this.$uploadButton=null;this.$filesContainer=null;this.uploaderOptions=null;this.options=null;c.dispose.call(this)};a.prototype.bindUploader=function(){this.uploaderOptions={url:this.options.url,paramName:this.options.paramName,clickable:this.$uploadButton.get(0),previewsContainer:this.$filesContainer.get(0),maxFiles:!this.options.isMulti?1:null,headers:{}};if(this.options.fileTypes){this.uploaderOptions.acceptedFiles=this.options.fileTypes}if(this.options.template){this.uploaderOptions.previewTemplate=e(this.options.template).html()}if(this.options.uniqueId){this.uploaderOptions.headers["X-OCTOBER-FILEUPLOAD"]=this.options.uniqueId}this.uploaderOptions.thumbnailWidth=this.options.thumbnailWidth?this.options.thumbnailWidth:null;this.uploaderOptions.thumbnailHeight=this.options.thumbnailHeight?this.options.thumbnailHeight:null;this.uploaderOptions.resize=this.onResizeFileInfo;var f=e('meta[name="csrf-token"]').attr("content");if(f){this.uploaderOptions.headers["X-CSRF-TOKEN"]=f}this.dropzone=new Dropzone(this.$el.get(0),this.uploaderOptions);this.dropzone.on("addedfile",this.proxy(this.onUploadAddedFile));this.dropzone.on("sending",this.proxy(this.onUploadSending));this.dropzone.on("success",this.proxy(this.onUploadSuccess));this.dropzone.on("error",this.proxy(this.onUploadError))};a.prototype.onResizeFileInfo=function(h){var i,g,f;if(!this.options.thumbnailWidth&&!this.options.thumbnailWidth){g=f=100}else{if(this.options.thumbnailWidth){g=this.options.thumbnailWidth;f=this.options.thumbnailWidth*h.height/h.width}else{if(this.options.thumbnailHeight){g=this.options.thumbnailHeight*h.height/h.width;f=this.options.thumbnailHeight}}}i={srcX:0,srcY:0,srcWidth:h.width,srcHeight:h.height,trgX:0,trgY:0,trgWidth:g,trgHeight:f};return i};a.prototype.onUploadAddedFile=function(f){var g=e(f.previewElement).data("dzFileObject",f);if(!this.options.isMulti){this.removeFileFromElement(g.siblings())}this.evalIsPopulated()};a.prototype.onUploadSending=function(f,h,g){this.addExtraFormData(g)};a.prototype.onUploadSuccess=function(h,f){var i=e(h.previewElement),g=e(".image img",i);i.addClass("is-success");if(f.id){i.data("id",f.id);i.data("path",f.path);e(".upload-remove-button",i).data("request-data",{file_id:f.id});g.attr("src",f.thumb)}this.$el.closest("[data-field-name]").trigger("change.oc.formwidget")};a.prototype.onUploadError=function(g,f){var h=e(g.previewElement);h.addClass("is-error")};a.prototype.addExtraFormData=function(g){if(this.options.extraData){e.each(this.options.extraData,function(h,i){g.append(h,i)})}var f=this.$el.closest("form");if(f.length>0){e.each(f.serializeArray(),function(h,i){g.append(i.name,i.value)})}};a.prototype.removeFileFromElement=function(f){var g=this;f.each(function(){var h=e(this),i=h.data("dzFileObject");if(i){g.dropzone.removeFile(i)}else{h.remove()}})};a.prototype.bindSortable=function(){var f=this,g=e('<div class="upload-object upload-placeholder"/>').css({width:this.options.imageWidth,height:this.options.imageHeight});this.$filesContainer.sortable({itemSelector:"div.upload-object.is-success",nested:false,tolerance:-100,placeholder:g,handle:".drag-handle",onDrop:function(i,h,j){j(i,h);f.onSortAttachments()},distance:10})};a.prototype.onSortAttachments=function(){if(this.options.sortHandler){var f={};this.$el.find(".upload-object.is-success").each(function(g){var h=e(this).data("id");f[h]=g+1});this.$el.request(this.options.sortHandler,{data:{sortOrder:f}})}};a.prototype.onRemoveObject=function(h){var f=this,g=e(h.target).closest(".upload-object");e(h.target).closest(".upload-remove-button").one("ajaxPromise",function(){g.addClass("is-loading")}).one("ajaxDone",function(){f.removeFileFromElement(g);f.evalIsPopulated()}).request();h.stopPropagation()};a.prototype.onClickSuccessObject=function(g){if(e(g.target).closest(".meta").length){return}var f=e(g.target).closest(".upload-object");if(!this.options.configHandler){window.open(f.data("path"));return}f.popup({handler:this.options.configHandler,extraData:{file_id:f.data("id")}});f.one("popupComplete",function(j,h,i){i.one("ajaxDone","button[type=submit]",function(m,k,l){if(l.displayName){e("[data-dz-name]",f).text(l.displayName)}})})};a.prototype.onClickErrorObject=function(j){var g=this,f=e(j.target).closest(".upload-object"),i=e("[data-dz-errormessage]",f).text(),h=e(this.options.errorTemplate);if(!this.options.isMulti){this.removeFileFromElement(f.siblings())}f.ocPopover({content:Mustache.render(h.html(),{errorMsg:i}),modal:true,highlightModalTarget:true,placement:"top",fallbackPlacement:"left",containerClass:"popover-danger"});var k=f.data("oc.popover").$container;k.one("click","[data-remove-file]",function(){f.data("oc.popover").hide();g.removeFileFromElement(f);g.evalIsPopulated()})};a.prototype.evalIsPopulated=function(){var f=!!e(".upload-object",this.$filesContainer).length;this.$el.toggleClass("is-populated",f);if(!f){this.dropzone.removeAllFiles()}};a.DEFAULTS={url:window.location,configHandler:null,sortHandler:null,uniqueId:null,extraData:{},paramName:"file_data",fileTypes:null,template:null,errorTemplate:null,isMulti:null,isPreview:null,isSortable:null,thumbnailWidth:120,thumbnailHeight:120};var b=e.fn.fileUploader;e.fn.fileUploader=function(f){return this.each(function(){var i=e(this);var h=i.data("oc.fileUpload");var g=e.extend({},a.DEFAULTS,i.data(),typeof f=="object"&&f);if(!h){i.data("oc.fileUpload",(h=new a(this,g)))}if(typeof f=="string"){h[f].call(i)}})};e.fn.fileUploader.Constructor=a;e.fn.fileUploader.noConflict=function(){e.fn.fileUpload=b;return this};e(document).render(function(){e('[data-control="fileupload"]').fileUploader()})}(window.jQuery);