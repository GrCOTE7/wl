+function(e){var d=e.oc.foundation.base,c=d.prototype;var b=function(g,f){this.$el=e(g);this.options=f||{};this.$textarea=e("textarea:first",this.$el);this.$toolbar=e(".editor-toolbar:first",this.$el);this.$write=e(".editor-write:first",this.$el);this.$preview=e(".editor-preview:first",this.$el);this.$code=null;this.editor=null;this.$form=null;this.$buttons=null;this.$fixedButtons=null;this.$indicator=null;this.editorPadding=15;this.updatesPaused=false;e.oc.foundation.controlUtils.markDisposable(g);d.call(this);this.init()};b.prototype=Object.create(c);b.prototype.constructor=b;b.prototype.init=function(){this.$el.one("dispose-control",this.proxy(this.dispose));if(!this.$el.attr("id")){this.$el.attr("id","element-"+Math.random().toString(36).substring(7))}this.$form=this.$el.closest("form");this.createCodeContainer();this.createToolbar();this.createIndicator();this.setViewMode(this.options.viewMode);this.$toolbar.on("click",".btn, .md-dropdown-button",this.proxy(this.onClickToolbarButton));this.$form.on("oc.beforeRequest",this.proxy(this.onBeforeRequest));this.editor.on("change",this.proxy(this.onEditorChange));this.editor.getSession().on("changeScrollTop",this.proxy(this.onEditorScrollTop));e('[data-control="tooltip"]',this.$toolbar).tooltip();e('[data-toggle="dropdown"]',this.$toolbar).dropdown()};b.prototype.dispose=function(){this.$el.off("dispose-control",this.proxy(this.dispose));this.$toolbar.off("click",".btn, .md-dropdown-button",this.proxy(this.onClickToolbarButton));this.$form.off("oc.beforeRequest",this.proxy(this.onBeforeRequest));this.editor.off("change",this.proxy(this.onEditorChange));e(window).off("resize",this.proxy(this.updateFullscreen));this.$el.removeData("oc.markdownEditor");this.$el=null;this.$textarea=null;this.$toolbar=null;this.$write=null;this.$preview=null;this.$code=null;this.editor=null;this.$form=null;this.$buttons=null;this.$fixedButtons=null;this.$indicator=null;this.editorPadding=null;this.updatesPaused=null;this.isSplitMode=null;this.isPreview=null;this.isFullscreen=null;this.dataTrackInputTimer=null;this.options=null;c.dispose.call(this)};b.prototype.onClickToolbarButton=function(h){var f=e(h.target),j=f.is("a")?f:f.closest(".btn"),i=j.data("button-action"),g=j.data("button-template");j.blur();this.pauseUpdates();if(g){this[i](g)}else{this[i]()}this.resumeUpdates();this.handleChange()};b.prototype.onEditorScrollTop=function(h){if(!this.isSplitMode){return}var j=this.$preview.height(),g,f,i;if(j!=this.$el.data("markdowneditor-canvas-height")){g=(this.editor.getSession().getScreenLength()*this.editor.renderer.lineHeight)-j;f=this.$preview.get(0).scrollHeight-j;i=f/g;this.$el.data("markdowneditor-canvas-height",j);this.$el.data("markdowneditor-scroll-ratio",i)}else{i=this.$el.data("markdowneditor-scroll-ratio")}h+=this.editorPadding;this.$preview.scrollTop(h*i)};b.prototype.onEditorChange=function(){var f=this.editor.getSession().getValue();this.$form.trigger("change");this.$textarea.trigger("changeContent.oc.markdowneditor",[this,f]);this.handleChange()};b.prototype.onBeforeRequest=function(){this.$textarea.val(this.editor.getSession().getValue())};b.prototype.onResize=function(){this.editor.resize()};b.prototype.onBlur=function(){this.$el.removeClass("editor-focus")};b.prototype.onFocus=function(){this.$el.addClass("editor-focus")};b.prototype.createToolbar=function(){var f=this,i,g=e('<div class="toolbar-item toolbar-primary" />'),h=e('<div class="toolbar-item" data-calculate-width />');e.each(e.oc.markdownEditorButtons,function(k,j){i=f.makeToolbarButton(k,j);if(j.fixed){h.append(i)}else{g.append(i)}if(j.dropdown){i.attr("data-toggle","dropdown");f.createToolbarDropdown(j,i)}});g.wrapInner('<div data-control="toolbar" />');this.$toolbar.append(g);this.$toolbar.append(h);this.$fixedButtons=h;this.$buttons=g};b.prototype.createToolbarDropdown=function(g,f){var h=e('<ul class="dropdown-menu" />'),i;h.attr("data-dropdown-title",e.oc.lang.get(g.label));e.each(g.dropdown,function(k,j){i=e("<a />").attr({href:"javascript:;","class":"md-dropdown-button",tabindex:"-1","data-button-code":k,"data-button-action":j.action});if(j.template){i.attr("data-button-template",j.template)}if(j.cssClass){i.addClass(j.cssClass)}i.text(e.oc.lang.get(j.label));h.append(i);i.wrap("<li />")});f.wrap('<div class="dropdown dropdown-fixed" />');f.after(h)};b.prototype.makeToolbarButton=function(g,f){var h=e("<button />").attr({type:"button","class":"btn",title:e.oc.lang.get(f.label),"data-control":"tooltip","data-placement":"bottom","data-container":"body","data-button-code":g});if(f.action){h.attr("data-button-action",f.action)}if(f.template){h.attr("data-button-template",f.template)}if(f.cssClass){h.addClass(f.cssClass)}else{h.append('<i class="icon-'+f.icon+'"></i>')}return h};b.prototype.addToolbarButton=function(i,g){var j=this.makeToolbarButton(i,g);var h=g.insertBefore||g.insertAfter;if(h){var f=this.findToolbarButton(h);if(!!f.length&&g.insertBefore){f.before(j)}else{if(!!f.length&&g.insertAfter){f.after(j)}}}else{if(g.fixed){this.$fixedButtons.append(j)}else{e('[data-control="toolbar"]',this.$buttons).append(j)}}return j};b.prototype.findToolbarButton=function(f){return e("[data-button-code="+f+"]",this.$toolbar)};b.prototype.createCodeContainer=function(){this.$code=e("<div />").addClass("editor-code").attr("id",this.$el.attr("id")+"-code").css({position:"absolute",top:0,right:0,bottom:0,left:0}).appendTo(this.$write);var f=this.editor=ace.edit(this.$code.attr("id"));f.$blockScrolling=Infinity;f.getSession().setValue(this.$textarea.val());assetManager.load({js:[this.options.vendorPath+"/theme-github.js"]},function(){f.setTheme("ace/theme/github")});f.getSession().setMode({path:"ace/mode/markdown"});f.setHighlightActiveLine(false);f.renderer.setShowGutter(false);f.renderer.setShowPrintMargin(false);f.getSession().setUseWrapMode(true);f.setFontSize(14);f.on("blur",this.proxy(this.onBlur));f.on("focus",this.proxy(this.onFocus));ace.require("ace/config").set("basePath",this.options.vendorPath);f.renderer.setPadding(this.editorPadding);f.renderer.setScrollMargin(this.editorPadding,this.editorPadding,0,0);setTimeout(function(){f.resize()},100)};b.prototype.handleChange=function(){if(this.updatesPaused){return}var f=this;if(!this.isSplitMode){return}if(this.loading){if(this.dataTrackInputTimer===undefined){this.dataTrackInputTimer=window.setInterval(function(){f.handleChange()},100)}return}window.clearTimeout(this.dataTrackInputTimer);this.dataTrackInputTimer=undefined;f.updatePreview()};b.prototype.getEditorObject=function(){return this.editor};b.prototype.getContent=function(){return this.editor.getSession().getValue()};b.prototype.setContent=function(f){this.editor.getSession().setValue(f)};b.prototype.updatePreview=function(){var f=this;this.loading=true;this.showIndicator();this.$el.request(this.options.refreshHandler,{success:function(g){this.success(g);f.$preview.html(g.preview);f.initPreview()}}).done(function(){f.hideIndicator();f.loading=false})};b.prototype.initPreview=function(){e("pre",this.$preview).addClass("prettyprint");prettyPrint();this.$el.trigger("initPreview.oc.markdowneditor")};b.prototype.pauseUpdates=function(){this.updatesPaused=true};b.prototype.resumeUpdates=function(){this.updatesPaused=false};b.prototype.createIndicator=function(){this.$indicator=e('<div class="editor-preview-loader"></div>');this.$el.prepend(this.$indicator);this.$indicator.css("display","none")};b.prototype.showIndicator=function(){this.$indicator.css("display","block")};b.prototype.hideIndicator=function(){this.$indicator.css("display","none")};b.prototype.setViewMode=function(f){this.isSplitMode=f=="split";e('[data-button-code="preview"]',this.$toolbar).toggle(!this.isSplitMode);this.$el.removeClass("mode-tab mode-split").addClass("mode-"+f);if(this.isSplitMode){this.updatePreview()}};b.prototype.setFullscreen=function(f){this.isFullscreen=f;this.$el.toggleClass("is-fullscreen",f);if(f){e("body, html").css("overflow","hidden");this.updateFullscreen();this.setViewMode("split");e(window).on("resize",this.proxy(this.updateFullscreen))}else{this.setViewMode(this.options.viewMode);this.$preview.css("height","");this.$write.css("height","");e("body, html").css("overflow","");e(window).off("resize",this.proxy(this.updateFullscreen));this.editor.resize()}e(window).trigger("oc.updateUi")};b.prototype.updateFullscreen=function(){if(!this.isFullscreen){return}var f={height:e(document).height()-this.$toolbar.outerHeight()};this.$preview.css(f);this.$write.css(f);this.editor.resize()};b.prototype.launchMediaManager=function(g){var f=this;new e.oc.mediaManager.popup({alias:"ocmediamanager",cropAndInsertButton:true,onInsert:function(j){if(!j.length){alert("Please select image(s) to insert.");return}if(j.length>1){alert("Please select a single item.");return}var m,l;for(var k=0,h=j.length;k<h;k++){m=j[k].path;l=j[k].publicUrl}l=l.replace(/\s/g,"%20");g(l);this.hide()}})};b.prototype.toggleFullscreen=function(){this.setFullscreen(!this.isFullscreen);if(this.isPreview){this.togglePreview()}this.editor.focus();e('[data-button-code="fullscreen"]',this.$toolbar).toggleClass("active")};b.prototype.togglePreview=function(){this.isPreview=!this.isPreview;if(this.isPreview){this.updatePreview()}else{this.editor.focus()}this.$el.toggleClass("is-preview",this.isPreview);e(".btn",this.$buttons).prop("disabled",this.isPreview);e('[data-button-code="preview"]',this.$toolbar).toggleClass("active")};b.prototype.insertLine=function(g){var f=this.editor,h=this.editor.getCursorPosition();if(h.column==0){f.selection.clearSelection()}else{f.navigateTo(f.getSelectionRange().start.row,Number.MAX_VALUE)}f.insert(g);f.focus()};b.prototype.formatInline=function(g){var f=this.editor,i=this.editor.getCursorPosition(),h=f.session.getTextRange(f.selection.getRange()).trim();if(!h.length){f.selection.selectWord();h=f.session.getTextRange(f.selection.getRange()).trim()}f.insert(g.replace("$1",h));f.moveCursorToPosition(i);if(g.indexOf("$1")!=-1){f.navigateRight(g.indexOf("$1"))}f.focus()};b.prototype.formatBlock=function(g){var f=this.editor,i=this.editor.getCursorPosition(),h=f.session.getTextRange(f.selection.getRange()).trim();if(!h.length){f.navigateTo(f.getSelectionRange().start.row,0);f.selection.selectLineEnd();h=f.session.getTextRange(f.selection.getRange()).trim()}else{f.insert("\n")}f.insert(g.replace("$1",h));f.moveCursorToPosition(i);if(g.indexOf("$1")!=-1){f.navigateRight(g.indexOf("$1"))}f.focus()};b.prototype.formatBlockMulti=function(j){var h=this.editor,l=this.editor.getCursorPosition(),k=h.session.getTextRange(h.selection.getRange()).trim();if(!k.length){h.navigateTo(h.getSelectionRange().start.row,0);h.selection.selectLineEnd()}var f=h.selection.getRange();for(var g=f.start.row+1;g<f.end.row+2;g++){h.gotoLine(g);h.insert(j.replace("$1",""))}h.moveCursorToPosition(l);h.focus()};b.prototype.formatMediaManager=function(h){var f=this,g=this.editor,j=this.editor.getCursorPosition(),i=g.session.getTextRange(g.selection.getRange()).trim();if(!i.length){g.selection.selectWord();i=g.session.getTextRange(g.selection.getRange()).trim()}this.launchMediaManager(function(k){g.insert(h.replace("$1",i).replace("$2",k));g.moveCursorToPosition(j);g.focus();if(!i.length&&h.indexOf("$1")!=-1){g.navigateRight(h.indexOf("$1"))}})};b.DEFAULTS={vendorPath:"/",refreshHandler:null,buttons:["formatting","bold","italic","unorderedlist","orderedlist","link","horizontalrule"],viewMode:"tab"};var a=e.fn.markdownEditor;e.fn.markdownEditor=function(i){var h=Array.prototype.slice.call(arguments,1),g,f;g=this.each(function(){var l=e(this);var k=l.data("oc.markdownEditor");var j=e.extend({},b.DEFAULTS,l.data(),typeof i=="object"&&i);if(!k){l.data("oc.markdownEditor",(k=new b(this,j)))}if(typeof i=="string"){f=k[i].apply(k,h)}if(typeof f!="undefined"){return false}});return f?f:g};e.fn.markdownEditor.Constructor=b;e.fn.markdownEditor.noConflict=function(){e.fn.markdownEditor=a;return this};e(document).render(function(){e('[data-control="markdowneditor"]').markdownEditor()});if(e.oc===undefined){e.oc={}}e.oc.markdownEditorButtons={formatting:{label:"markdowneditor.formatting",icon:"paragraph",dropdown:{quote:{label:"markdowneditor.quote",cssClass:"oc-button oc-icon-quote-right",action:"formatBlockMulti",template:"> $1"},code:{label:"markdowneditor.code",cssClass:"oc-button oc-icon-code",action:"formatBlock",template:"\n```\n$1\n```\n"},header1:{label:"markdowneditor.header1",cssClass:"oc-button oc-icon-header",action:"formatBlock",template:"# $1"},header2:{label:"markdowneditor.header2",cssClass:"oc-button oc-icon-header",action:"formatBlock",template:"## $1"},header3:{label:"markdowneditor.header3",cssClass:"oc-button oc-icon-header",action:"formatBlock",template:"### $1"},header4:{label:"markdowneditor.header4",cssClass:"oc-button oc-icon-header",action:"formatBlock",template:"#### $1"},header5:{label:"markdowneditor.header5",cssClass:"oc-button oc-icon-header",action:"formatBlock",template:"##### $1"},header6:{label:"markdowneditor.header6",cssClass:"oc-button oc-icon-header",action:"formatBlock",template:"###### $1"}}},bold:{label:"markdowneditor.bold",icon:"bold",action:"formatInline",template:"**$1**"},italic:{label:"markdowneditor.italic",icon:"italic",action:"formatInline",template:"*$1*"},unorderedlist:{label:"markdowneditor.unorderedlist",icon:"list-ul",action:"formatBlockMulti",template:"* $1"},orderedlist:{label:"markdowneditor.orderedlist",icon:"list-ol",action:"formatBlockMulti",template:"1. $1"},link:{label:"markdowneditor.link",icon:"link",action:"formatInline",template:"[$1](http://)"},image:{label:"markdowneditor.image",icon:"image",action:"formatInline",template:"![$1](http://)"},horizontalrule:{label:"markdowneditor.horizontalrule",icon:"minus",action:"insertLine",template:"\n\n---\n"},medialink:{label:"mediamanager.insert_link",cssClass:"oc-autumn-button oc-icon-link",action:"formatMediaManager",template:"[$1]($2)"},mediaimage:{label:"mediamanager.insert_image",cssClass:"oc-autumn-button oc-icon-image",action:"formatMediaManager",template:"![$1]($2)"},fullscreen:{label:"markdowneditor.fullscreen",icon:"expand",action:"toggleFullscreen",fixed:true},preview:{label:"markdowneditor.preview",icon:"eye",action:"togglePreview",fixed:true}}}(window.jQuery);