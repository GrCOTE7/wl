+function(c){if(c.oc.mediaManager===undefined){c.oc.mediaManager={}}var b=c.oc.foundation.base,a=b.prototype;var d=function(f,e){this.$popupRootElement=null;this.$popupElement=null;this.selectionSizeLabel=null;this.imageArea=null;this.hRulerHolder=null;this.vRulerHolder=null;this.rulersVisible=false;this.prevScrollTop=0;this.prevScrollLeft=0;this.jCrop=null;this.options=c.extend({},d.DEFAULTS,e);this.path=f;b.call(this);this.init();this.show()};d.prototype=Object.create(a);d.prototype.constructor=d;d.prototype.dispose=function(){this.unregisterHandlers();this.removeAttachedControls();this.$popupRootElement.remove();this.$popupRootElement=null;this.$popupElement=null;this.selectionSizeLabel=null;this.imageArea=null;this.hRulerHolder=null;this.vRulerHolder=null;a.dispose.call(this)};d.prototype.init=function(){if(this.options.alias===undefined){throw new Error('Media Manager image crop popup option "alias" is not set.')}this.$popupRootElement=c("<div/>");this.registerHandlers()};d.prototype.show=function(){var e={path:this.path};this.$popupRootElement.popup({extraData:e,size:"adaptive",adaptiveHeight:true,handler:this.options.alias+"::onLoadImageCropPopup",zIndex:1200})};d.prototype.registerHandlers=function(){this.$popupRootElement.one("hide.oc.popup",this.proxy(this.onPopupHidden));this.$popupRootElement.one("shown.oc.popup",this.proxy(this.onPopupShown))};d.prototype.unregisterHandlers=function(){this.$popupElement.off("change",'[data-control="selection-mode"]',this.proxy(this.onSelectionModeChanged));this.$popupElement.off("click","[data-command]",this.proxy(this.onCommandClick));this.$popupElement.off("shown.oc.popup","button[data-command=resize]",this.proxy(this.onResizePopupShown));this.$popupElement.off("hidden.oc.popup","button[data-command=resize]",this.proxy(this.onResizePopupHidden));if(this.rulersVisible){var e=this.$popupElement.find("[data-control=media-manager-crop-tool]");this.imageArea.removeEventListener("scroll",this.proxy(this.onImageScroll))}this.getWidthInput().off("change",this.proxy(this.onSizeInputChange));this.getHeightInput().off("change",this.proxy(this.onSizeInputChange))};d.prototype.removeAttachedControls=function(){if(this.$popupElement){this.$popupElement.find('[data-control="selection-mode"]').select2("destroy").remove();this.$popupElement.find("[data-control=toolbar]").toolbar("dispose").remove();this.jCrop.destroy()}this.jCrop=null};d.prototype.hide=function(){if(this.$popupElement){this.$popupElement.trigger("close.oc.popup")}};d.prototype.getSelectionMode=function(){return this.$popupElement.find('[data-control="selection-mode"]').val()};d.prototype.initRulers=function(){if(!Modernizr.csstransforms){return}var g=this.$popupElement.find("[data-control=media-manager-crop-tool]"),i=g.data("image-width"),e=g.data("image-height");if(!i||!e){return}if(g.width()>i){i=c(window).width()}if(g.height()>e){e=c(window).height()}g.find(".ruler-container").removeClass("hide");g.addClass("has-rulers");var h=g.find("[data-control=h-ruler]"),f=g.find("[data-control=v-ruler]"),k=i/40+1,j=e/40+1;this.createRulerTicks(h,k);this.createRulerTicks(f,j);this.rulersVisible=true;this.imageArea.addEventListener("scroll",this.proxy(this.onImageScroll));this.hRulerHolder=g.find(".ruler-container.horizontal .layout-relative").get(0);this.vRulerHolder=g.find(".ruler-container.vertical .layout-relative").get(0)};d.prototype.createRulerTicks=function(f,h){var j=document.createElement("ul");for(var g=0;g<=h;g++){var e=document.createElement("li");e.textContent=g*40;j.appendChild(e)}f.append(j)};d.prototype.initJCrop=function(){this.jCrop=c.Jcrop(c(this.imageArea).find("img").get(0),{shade:true,onChange:this.proxy(this.onSelectionChanged)})};d.prototype.fixDimensionValue=function(f){var e=f.replace(/[^0-9]+/,"");if(!e.length){e=200}if(e=="0"){e=1}return e};d.prototype.getWidthInput=function(){return this.$popupElement.find('[data-control="crop-width-input"]')};d.prototype.getHeightInput=function(){return this.$popupElement.find('[data-control="crop-height-input"]')};d.prototype.applySelectionMode=function(){if(!this.jCrop){return}var f=this.getWidthInput(),h=this.getHeightInput(),g=this.fixDimensionValue(f.val()),e=this.fixDimensionValue(h.val()),i=this.getSelectionMode();switch(i){case"fixed-ratio":this.jCrop.setOptions({aspectRatio:g/e,minSize:[0,0],maxSize:[0,0],allowResize:true});break;case"fixed-size":this.jCrop.setOptions({aspectRatio:0,minSize:[g,e],maxSize:[g,e],allowResize:false});break;case"normal":this.jCrop.setOptions({aspectRatio:0,minSize:[0,0],maxSize:[0,0],allowResize:true});break}};d.prototype.cropAndInsert=function(){var e={img:c(this.imageArea).find("img").attr("src"),selection:this.jCrop.tellSelect()};c.oc.stripeLoadIndicator.show();this.$popupElement.find("form").request(this.options.alias+"::onCropImage",{data:e}).always(function(){c.oc.stripeLoadIndicator.hide()}).done(this.proxy(this.onImageCropped))};d.prototype.onImageCropped=function(e){this.hide();if(this.options.onDone!==undefined){this.options.onDone(e)}};d.prototype.showResizePopup=function(){this.$popupElement.find("button[data-command=resize]").popup({content:this.$popupElement.find('[data-control="resize-template"]').html(),zIndex:1220})};d.prototype.onResizePopupShown=function(k,i,f){var l=c(f),j=l.find("input[name=width]"),h=l.find("input[name=height]"),g=this.fixDimensionValue(this.$popupElement.find("input[data-control=dimension-width]").val()),e=this.fixDimensionValue(this.$popupElement.find("input[data-control=dimension-height]").val());j.val(g);h.val(e);j.focus();l.on("submit.media","form",this.proxy(this.onResizeSubmit));j.on("keyup.media",this.proxy(this.onResizeDimensionKeyUp));h.on("keyup.media",this.proxy(this.onResizeDimensionKeyUp));j.on("change.media",this.proxy(this.onResizeDimensionChanged));h.on("change.media",this.proxy(this.onResizeDimensionChanged))};d.prototype.onResizePopupHidden=function(i,g,e){var j=c(e),h=j.find("input[name=width]"),f=j.find("input[name=height]");j.off(".media","form");h.off(".media");f.off(".media")};d.prototype.onResizeDimensionKeyUp=function(i){var e=c(i.target),h=this.fixDimensionValue(e.val()),f=e.attr("name")=="width"?"height":"width",k=e.closest("form").find("input[name="+f+"]"),g=this.$popupElement.find("[data-control=original-ratio]").val(),j=f=="height"?h/g:h*g;k.val(Math.round(j))};d.prototype.onResizeDimensionChanged=function(f){var e=c(f.target);e.val(this.fixDimensionValue(e.val()))};d.prototype.onResizeSubmit=function(e){var f={cropSessionKey:this.$popupElement.find("input[name=cropSessionKey]").val(),path:this.$popupElement.find("input[name=path]").val()};c.oc.stripeLoadIndicator.show();c(e.target).request(this.options.alias+"::onResizeImage",{data:f}).always(function(){c.oc.stripeLoadIndicator.hide()}).done(this.proxy(this.imageResized));e.preventDefault();return false};d.prototype.imageResized=function(e){this.$popupElement.find("button[data-command=resize]").popup("hide");this.updateImage(e.url,e.dimensions[0],e.dimensions[1])};d.prototype.updateImage=function(e,g,i){this.jCrop.destroy();this.$popupElement.find("span[data-label=width]").text(g);this.$popupElement.find("span[data-label=height]").text(i);this.$popupElement.find("input[data-control=dimension-width]").val(g);this.$popupElement.find("input[data-control=dimension-height]").val(i);var h=c(this.imageArea);h.find("img").remove();var f=c("<img>").attr("src",e);f.one("load",this.proxy(this.initJCrop));h.append(f);this.imageArea.scrollTop=0;this.imageArea.scrollLeft=0;this.onImageScroll()};d.prototype.undoResizing=function(){this.updateImage(this.$popupElement.find("input[data-control=original-url]").val(),this.$popupElement.find("input[data-control=original-width]").val(),this.$popupElement.find("input[data-control=original-height]").val())};d.prototype.updateSelectionSizeLabel=function(f,e){if(f==0&&e==0){this.selectionSizeLabel.setAttribute("class","hide");return}this.selectionSizeLabel.setAttribute("class","");this.selectionSizeLabel.querySelector("[data-label=selection-width]").textContent=parseInt(f);this.selectionSizeLabel.querySelector("[data-label=selection-height]").textContent=parseInt(e)};d.prototype.onPopupHidden=function(g,f,e){this.$popupElement.find("form").request(this.options.alias+"::onEndCroppingSession");c(document).trigger("mousedown");this.dispose()};d.prototype.onPopupShown=function(g,f,e){this.$popupElement=e;this.$popupElement.on("change",'[data-control="selection-mode"]',this.proxy(this.onSelectionModeChanged));this.$popupElement.on("click","[data-command]",this.proxy(this.onCommandClick));this.$popupElement.on("shown.oc.popup","button[data-command=resize]",this.proxy(this.onResizePopupShown));this.$popupElement.on("hidden.oc.popup","button[data-command=resize]",this.proxy(this.onResizePopupHidden));this.imageArea=e.find("[data-control=media-manager-crop-tool]").get(0).querySelector(".image_area");this.selectionSizeLabel=e.find('[data-label="selection-size"]').get(0);this.getWidthInput().on("change",this.proxy(this.onSizeInputChange));this.getHeightInput().on("change",this.proxy(this.onSizeInputChange));this.initRulers();this.initJCrop();this.applySelectionMode()};d.prototype.onSelectionModeChanged=function(){var g=this.getSelectionMode(),e=this.getWidthInput(),f=this.getHeightInput();if(g==="normal"){e.attr("disabled","disabled");f.attr("disabled","disabled")}else{e.removeAttr("disabled");f.removeAttr("disabled");e.val(this.fixDimensionValue(e.val()));f.val(this.fixDimensionValue(f.val()))}this.applySelectionMode()};d.prototype.onImageScroll=function(){var e=this.imageArea.scrollTop,f=this.imageArea.scrollLeft;if(this.prevScrollTop!=e){this.prevScrollTop=e;this.vRulerHolder.scrollTop=e}if(this.prevScrollLeft!=f){this.prevScrollLeft=f;this.hRulerHolder.scrollLeft=f}};d.prototype.onSizeInputChange=function(f){var e=c(f.target);e.val(this.fixDimensionValue(e.val()));this.applySelectionMode()};d.prototype.onCommandClick=function(e){var f=c(e.currentTarget).data("command");switch(f){case"insert":this.cropAndInsert();break;case"resize":this.showResizePopup();break;case"undo-resizing":this.undoResizing();break}};d.prototype.onSelectionChanged=function(e){this.updateSelectionSizeLabel(e.w,e.h)};d.DEFAULTS={alias:undefined,onDone:undefined};c.oc.mediaManager.imageCropPopup=d}(window.jQuery);