+function(c){if(c.oc===undefined){c.oc={}}if(c.oc.table===undefined){c.oc.table={}}var b=function(e,d){this.el=e;this.$el=c(e);this.options=d;this.disposed=false;this.dataSource=null;this.cellProcessors={};this.activeCellProcessor=null;this.activeCell=null;this.tableContainer=null;this.dataTableContainer=null;this.editedRowKey=null;this.dataTable=null;this.headerTable=null;this.toolbar=null;this.clickHandler=this.onClick.bind(this);this.keydownHandler=this.onKeydown.bind(this);this.documentClickHandler=this.onDocumentClick.bind(this);this.toolbarClickHandler=this.onToolbarClick.bind(this);if(this.options.postback&&this.options.clientDataSourceClass=="client"){this.formSubmitHandler=this.onFormSubmit.bind(this)}this.navigation=null;this.recordsAddedOrDeleted=0;this.disposeBound=this.dispose.bind(this);this.init();c.oc.foundation.controlUtils.markDisposable(e)};b.prototype.init=function(){this.createDataSource();this.initCellProcessors();this.navigation=new c.oc.table.helper.navigation(this);this.buildUi();this.registerHandlers()};b.prototype.disposeCellProcessors=function(){for(var e=0,d=this.options.columns.length;e<d;e++){var f=this.options.columns[e].key;this.cellProcessors[f].dispose();this.cellProcessors[f]=null}this.cellProcessors=null;this.activeCellProcessor=null};b.prototype.createDataSource=function(){var d=this.options.clientDataSourceClass;if(c.oc.table.datasource===undefined||c.oc.table.datasource[d]==undefined){throw new Error('The table client-side data source class "'+d+'" is not found in the $.oc.table.datasource namespace.')}this.dataSource=new c.oc.table.datasource[d](this)};b.prototype.registerHandlers=function(){this.el.addEventListener("click",this.clickHandler);this.el.addEventListener("keydown",this.keydownHandler);this.$el.one("dispose-control",this.disposeBound);document.addEventListener("click",this.documentClickHandler);if(this.options.postback&&this.options.clientDataSourceClass=="client"){this.$el.closest("form").bind("oc.beforeRequest",this.formSubmitHandler)}var d=this.getToolbar();if(d){d.addEventListener("click",this.toolbarClickHandler)}};b.prototype.unregisterHandlers=function(){this.el.removeEventListener("click",this.clickHandler);document.removeEventListener("click",this.documentClickHandler);this.clickHandler=null;this.el.removeEventListener("keydown",this.keydownHandler);this.keydownHandler=null;var d=this.getToolbar();if(d){d.removeEventListener("click",this.toolbarClickHandler)}this.toolbarClickHandler=null;if(this.formSubmitHandler){this.$el.closest("form").unbind("oc.beforeRequest",this.formSubmitHandler);this.formSubmitHandler=null}};b.prototype.initCellProcessors=function(){for(var g=0,e=this.options.columns.length;g<e;g++){var d=this.options.columns[g],h=d.key,f=d.type;if(f===undefined){f="string";this.options.columns[g].type=f}if(c.oc.table.processor===undefined||c.oc.table.processor[f]==undefined){throw new Error('The table cell processor for the column type "'+f+'" is not found in the $.oc.table.processor namespace.')}this.cellProcessors[h]=new c.oc.table.processor[f](this,h,d)}};b.prototype.getCellProcessor=function(d){return this.cellProcessors[d]};b.prototype.buildUi=function(){this.tableContainer=document.createElement("div");this.tableContainer.setAttribute("class","table-container");if(this.options.toolbar){this.buildToolbar()}this.tableContainer.appendChild(this.buildHeaderTable());this.el.insertBefore(this.tableContainer,this.el.children[0]);if(!this.options.height){this.dataTableContainer=this.tableContainer}else{this.dataTableContainer=this.buildScrollbar()}this.updateDataTable()};b.prototype.buildToolbar=function(){if(!this.options.adding&&!this.options.deleting){return}this.toolbar=document.createElement("div");this.toolbar.setAttribute("class","toolbar");if(this.options.adding){var d=document.createElement("a");d.setAttribute("class","btn table-icon add-table-row-below");d.setAttribute("data-cmd","record-add-below");this.toolbar.appendChild(d);if(this.navigation.paginationEnabled()||!this.options.rowSorting){d.textContent=this.options.btnAddRowLabel}else{d.textContent=this.options.btnAddRowBelowLabel;var e=document.createElement("a");e.setAttribute("class","btn table-icon add-table-row-above");e.textContent="Add row above";e.setAttribute("data-cmd","record-add-above");this.toolbar.appendChild(e)}}if(this.options.deleting){var f=document.createElement("a");f.setAttribute("class","btn table-icon delete-table-row");f.textContent=this.options.btnDeleteRowLabel;f.setAttribute("data-cmd","record-delete");this.toolbar.appendChild(f)}this.tableContainer.appendChild(this.toolbar)};b.prototype.buildScrollbar=function(){var e=document.createElement("div"),d=document.createElement("div");e.setAttribute("class","control-scrollbar");if(this.options.dynamicHeight){e.setAttribute("style","max-height: "+this.options.height+"px")}else{e.setAttribute("style","height: "+this.options.height+"px")}e.appendChild(d);this.tableContainer.appendChild(e);c(e).scrollbar({animation:false});return d};b.prototype.buildHeaderTable=function(){var e=document.createElement("table"),g=document.createElement("tr");e.className="headers";e.appendChild(g);for(var f=0,d=this.options.columns.length;f<d;f++){var h=document.createElement("th");if(this.options.columns[f].width){h.setAttribute("style","width: "+this.options.columns[f].width)}h.textContent!==undefined?h.textContent=this.options.columns[f].title:h.innerText=this.options.columns[f].title;g.appendChild(h)}this.headerTable=e;return e};b.prototype.updateDataTable=function(f){var d=this;this.unfocusTable();this.fetchRecords(function e(h,g){d.buildDataTable(h,g);if(f){f()}if(g==0){d.addRecord("above",true)}d.$el.trigger("oc.tableUpdateData",[h,g]);d=null})};b.prototype.updateColumnWidth=function(){var e=this.headerTable.querySelectorAll("th"),g=this.dataTable.querySelectorAll("tr:first-child td");for(var f=0,d=e.length;f<d;f++){if(g[f]){g[f].setAttribute("style",e[f].getAttribute("style"))}}};b.prototype.buildDataTable=function(g,s){var e=document.createElement("table"),m=document.createElement("tbody"),d=this.options.keyColumn;e.setAttribute("class","data");for(var l=0,n=g.length;l<n;l++){var u=document.createElement("tr");if(g[l][d]===undefined){throw new Error("The row attribute "+d+" is not set for the row #"+l)}u.setAttribute("data-row",g[l][d]);for(var k=0,t=this.options.columns.length;k<t;k++){var q=document.createElement("td"),p=document.createElement("input"),r=document.createElement("div"),h=this.options.columns[k],f=h.key,o=this.getCellProcessor(f);q.setAttribute("data-column",f);q.setAttribute("data-column-type",h.type);p.setAttribute("type","hidden");p.setAttribute("data-container","data-container");p.value=this.formatDataContainerValue(g[l][f]);r.setAttribute("class","content-container");q.appendChild(r);u.appendChild(q);q.appendChild(p);o.renderCell(g[l][f],r)}m.appendChild(u)}e.appendChild(m);if(this.dataTable!==null){this.dataTableContainer.replaceChild(e,this.dataTable)}else{this.dataTableContainer.appendChild(e)}this.dataTable=e;this.updateColumnWidth();this.updateScrollbar();this.navigation.buildPagination(s)};b.prototype.formatDataContainerValue=function(d){if(d===undefined){return""}if(typeof d==="boolean"){return d?1:""}return d};b.prototype.fetchRecords=function(d){this.dataSource.getRecords(this.navigation.getPageFirstRowOffset(),this.options.recordsPerPage,d)};b.prototype.updateScrollbar=function(){if(!this.options.height){return}c(this.dataTableContainer.parentNode).data("oc.scrollbar").update()};b.prototype.scrollCellIntoView=function(){if(!this.options.height||!this.activeCell){return}c(this.dataTableContainer.parentNode).data("oc.scrollbar").gotoElement(this.activeCell)};b.prototype.disposeScrollbar=function(){if(!this.options.height){return}c(this.dataTableContainer.parentNode).data("oc.scrollbar").dispose();c(this.dataTableContainer.parentNode).data("oc.scrollbar",null)};b.prototype.setActiveProcessor=function(d){if(this.activeCellProcessor){this.activeCellProcessor.onUnfocus()}this.activeCellProcessor=d};b.prototype.commitEditedRow=function(){if(this.editedRowKey===null){return}var g=this.dataTable.querySelector('tr[data-row="'+this.editedRowKey+'"]');if(!g){return}if(g.getAttribute("data-dirty")!=1){return}var f=g.children,j={};for(var h=0,e=f.length;h<e;h++){var d=f[h];j[d.getAttribute("data-column")]=this.getCellValue(d)}this.dataSource.updateRecord(this.editedRowKey,j);g.setAttribute("data-dirty",0)};b.prototype.unfocusTable=function(){this.elementRemoveClass(this.el,"active");if(this.activeCellProcessor){this.activeCellProcessor.onUnfocus()}this.commitEditedRow();this.activeCellProcessor=null;if(this.activeCell){this.activeCell.setAttribute("class","")}this.activeCell=null};b.prototype.focusTable=function(){this.elementAddClass(this.el,"active")};b.prototype.focusCell=function(d,g){var e=d.getAttribute("data-column");if(e===null){return}this.focusTable();var f=this.getCellProcessor(e);if(!f){throw new Error("Cell processor not found for the column "+e)}if(this.activeCell!==d){if(this.activeCell){this.elementRemoveClass(this.activeCell,"active")}this.setActiveProcessor(f);this.activeCell=d;if(f.isCellFocusable()){this.elementAddClass(this.activeCell,"active")}}var h=this.getCellRowKey(d);if(this.editedRowKey!==null&&h!=this.editedRowKey){this.commitEditedRow()}this.editedRowKey=h;f.onFocus(d,g);this.scrollCellIntoView()};b.prototype.markCellRowDirty=function(d){d.parentNode.setAttribute("data-dirty",1)};b.prototype.addRecord=function(i,h){if(!this.activeCell||this.navigation.paginationEnabled()||!this.options.rowSorting){i="bottom"}var g=null,j=null;if(i=="above"||i=="below"){g=this.getCellRowKey(this.activeCell);j=this.getCellRowIndex(this.activeCell)}this.unfocusTable();if(this.navigation.paginationEnabled()){var f=this.navigation.getNewRowPage(i,j);if(f!=this.navigation.pageIndex){if(!this.validate()){return}}this.navigation.pageIndex=f}this.recordsAddedOrDeleted++;var e=this.options.keyColumn,d={},l=this;d[e]=-1*this.recordsAddedOrDeleted;this.$el.trigger("oc.tableNewRow",[d]);this.dataSource.createRecord(d,i,g,this.navigation.getPageFirstRowOffset(),this.options.recordsPerPage,function k(n,m){l.buildDataTable(n,m);var o=l.findRowByKey(d[e]);if(!o){throw new Error("New row is not found in the updated table: "+d[e])}if(!h){l.navigation.focusCell(o,0)}l=null})};b.prototype.deleteRecord=function(){if(!this.activeCell){return}var f=this.getCellRowIndex(this.activeCell),k=this.getCellRowKey(this.activeCell),l=this,g=this.navigation.paginationEnabled(),h=this.navigation.pageIndex,e=this.activeCell.cellIndex;if(g){this.navigation.pageIndex=this.navigation.getPageAfterDeletion(f)}this.recordsAddedOrDeleted++;var d=this.options.keyColumn,i={};i[d]=-1*this.recordsAddedOrDeleted;this.dataSource.deleteRecord(k,i,this.navigation.getPageFirstRowOffset(),this.options.recordsPerPage,function j(n,m){l.buildDataTable(n,m);if(!g){l.navigation.focusCellInReplacedRow(f,e)}else{if(h!=l.navigation.pageIndex){l.navigation.focusCell("bottom",e)}else{l.navigation.focusCellInReplacedRow(f,e)}}l=null})};b.prototype.notifyRowProcessorsOnChange=function(e){var f=e.getAttribute("data-column"),j=e.parentNode;for(var g=0,d=j.children.length;g<d;g++){var h=this.options.columns[g].key;this.cellProcessors[h].onRowValueChanged(f,j.children[g])}};b.prototype.getToolbar=function(){return this.tableContainer.querySelector("div.toolbar")};b.prototype.validate=function(){var r=this.dataTable.querySelectorAll("tbody tr[data-row]");for(var h=0,k=r.length;h<k;h++){var p=r[h];this.elementRemoveClass(p,"error")}for(var h=0,d=r.length;h<d;h++){var p=r[h],f=this.getRowData(p);for(var g=0,q=p.children.length;g<q;g++){this.elementRemoveClass(p.children[g],"error")}for(var e in f){var l=this.getCellProcessor(e),o=l.validate(f[e],f);if(o!==undefined){var m=p.querySelector('td[data-column="'+e+'"]'),n=this;this.elementAddClass(p,"error");this.elementAddClass(m,"error");c.oc.flashMsg({text:o,"class":"error"});window.setTimeout(function(){n.focusCell(m,false);m=null;n=null;l=null},100);return false}}}return true};b.prototype.onClick=function(g){this.focusTable();if(this.navigation.onClick(g)===false){return}for(var e=0,d=this.options.columns.length;e<d;e++){var f=this.options.columns[e].key;this.cellProcessors[f].onClick(g)}var h=this.getEventTarget(g,"TD");if(!h){return}if(h.tagName!="TD"){return}this.focusCell(h,true)};b.prototype.onKeydown=function(g){if(g.keyCode==65&&g.altKey&&this.options.adding){if(!g.shiftKey){this.addRecord("below")}else{this.addRecord("above")}this.stopEvent(g);return}if(g.keyCode==68&&g.altKey&&this.options.deleting){this.deleteRecord();this.stopEvent(g);return}for(var e=0,d=this.options.columns.length;e<d;e++){var f=this.options.columns[e].key;this.cellProcessors[f].onKeyDown(g)}if(this.navigation.onKeydown(g)===false){return}};b.prototype.onFormSubmit=function(d,e){if(e.handler==this.options.postbackHandlerName){this.unfocusTable();if(!this.validate()){d.preventDefault();return}var f=this.options.fieldName.indexOf("[")>-1?this.options.fieldName+"[TableData]":this.options.fieldName+"TableData";e.options.data[f]=this.dataSource.getAllData()}};b.prototype.onToolbarClick=function(d){var f=this.getEventTarget(d),e=f.getAttribute("data-cmd");if(!e){return}switch(e){case"record-add-below":this.addRecord("below");break;case"record-add-above":this.addRecord("above");break;case"record-delete":this.deleteRecord();break}this.stopEvent(d)};b.prototype.onDocumentClick=function(d){var e=this.getEventTarget(d);if(this.parentContainsElement(this.el,e)){return}if(this.activeCellProcessor&&this.activeCellProcessor.elementBelongsToProcessor(e)){return}this.unfocusTable()};b.prototype.dispose=function(){if(this.disposed){return}this.disposed=true;this.disposeBound=true;this.unfocusTable();this.dataSource.dispose();this.dataSource=null;this.unregisterHandlers();this.dataTable=null;this.headerTable=null;this.toolbar=null;this.disposeCellProcessors();this.navigation.dispose();this.navigation=null;this.disposeScrollbar();this.el=null;this.tableContainer=null;this.$el=null;this.dataTableContainer=null;this.activeCell=null};b.prototype.setRowValues=function(j,n){var m=this.findRowByIndex(j);if(!m){return false}var k=false;for(var f=0,h=m.children.length;f<h;f++){var l=m.children[f],e=this.getCellColumnName(l);for(var g in n){if(g==e){this.setCellValue(l,n[g],true);k=true}}}if(k){var d=this.editedRowKey;this.editedRowKey=this.getRowKey(m);this.commitEditedRow();this.editedRowKey=d}return true};b.prototype.getElement=function(){return this.el};b.prototype.getAlias=function(){return this.options.alias};b.prototype.getTableContainer=function(){return this.tableContainer};b.prototype.getDataTableBody=function(){return this.dataTable.children[0]};b.prototype.getEventTarget=function(f,d){var g=f.target?f.target:f.srcElement;if(d===undefined){return g}var e=g.tagName;while(e!=d){g=g.parentNode;if(!g){return null}e=g.tagName}return g};b.prototype.stopEvent=function(d){if(d.stopPropagation){d.stopPropagation()}else{d.cancelBubble=true}if(d.preventDefault){d.preventDefault()}else{d.returnValue=false}};b.prototype.elementHasClass=function(e,d){if(e.classList){return e.classList.contains(d)}return new RegExp("(^| )"+d+"( |$)","gi").test(e.className)};b.prototype.elementAddClass=function(e,d){if(this.elementHasClass(e,d)){return}if(e.classList){e.classList.add(d)}else{e.className+=" "+d}};b.prototype.elementRemoveClass=function(e,d){if(e.classList){e.classList.remove(d)}else{e.className=e.className.replace(new RegExp("(^|\\b)"+d.split(" ").join("|")+"(\\b|$)","gi")," ")}};b.prototype.parentContainsElement=function(e,d){while(d&&d!=e){d=d.parentNode}return d?true:false};b.prototype.getCellValue=function(d){return d.querySelector("[data-container]").value};b.prototype.getCellRowKey=function(d){return parseInt(d.parentNode.getAttribute("data-row"))};b.prototype.getRowKey=function(d){return parseInt(d.getAttribute("data-row"))};b.prototype.findRowByKey=function(d){return this.dataTable.querySelector('tbody tr[data-row="'+d+'"]')};b.prototype.findRowByIndex=function(d){return this.getDataTableBody().children[d]};b.prototype.getCellRowIndex=function(d){return parseInt(d.parentNode.rowIndex)};b.prototype.getRowCellValueByColumnName=function(f,e){var d=f.querySelector('td[data-column="'+e+'"]');if(!d){return d}return this.getCellValue(d)};b.prototype.getRowData=function(h){var f={};for(var g=0,e=h.children.length;g<e;g++){var d=h.children[g];f[d.getAttribute("data-column")]=this.getCellValue(d)}return f};b.prototype.getCellColumnName=function(d){return d.getAttribute("data-column")};b.prototype.setCellValue=function(d,f,e){var g=d.querySelector("[data-container]");if(g.value!=f){g.value=f;this.markCellRowDirty(d);this.notifyRowProcessorsOnChange(d);if(e===undefined||!e){this.$el.trigger("oc.tableCellChanged",[this.getCellColumnName(d),f,this.getCellRowIndex(d)])}}};b.DEFAULTS={clientDataSourceClass:"client",keyColumn:"id",recordsPerPage:false,data:null,postback:true,postbackHandlerName:"onSave",adding:true,deleting:true,toolbar:true,rowSorting:false,height:false,dynamicHeight:false,btnAddRowLabel:"Add row",btnAddRowBelowLabel:"Add row below",btnDeleteRowLabel:"Delete row"};var a=c.fn.table;c.fn.table=function(f){var e=Array.prototype.slice.call(arguments,1),d=undefined;this.each(function(){var i=c(this);var h=i.data("oc.table");var g=c.extend({},b.DEFAULTS,i.data(),typeof f=="object"&&f);if(!h){i.data("oc.table",(h=new b(this,g)))}if(typeof f=="string"){d=h[f].apply(h,e)}if(typeof d!="undefined"){return false}});return d?d:this};c.fn.table.Constructor=b;c.oc.table.table=b;c.fn.table.noConflict=function(){c.fn.table=a;return this};c(document).on("render",function(){c("div[data-control=table]").table()})}(window.jQuery);