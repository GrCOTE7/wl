+function(d){if(d.oc.builder===undefined){d.oc.builder={}}if(d.oc.builder.entityControllers===undefined){d.oc.builder.entityControllers={}}var c=d.oc.builder.entityControllers.base,a=c.prototype;var b=function(e){c.call(this,"databaseTable",e)};b.prototype=Object.create(a);b.prototype.constructor=b;b.prototype.cmdCreateTable=function(f){var e=this.indexController.openOrLoadMasterTab(d(f.target),"onDatabaseTableCreateOrOpen",this.newTabId());if(e!==false){e.done(this.proxy(this.onTableLoaded,this))}};b.prototype.cmdOpenTable=function(g){var f=d(g.currentTarget).data("id"),e=this.indexController.openOrLoadMasterTab(d(g.target),"onDatabaseTableCreateOrOpen",this.makeTabId(f),{table_name:f});if(e!==false){e.done(this.proxy(this.onTableLoaded,this))}};b.prototype.cmdSaveTable=function(f){var e=d(f.currentTarget);if(!this.validateTable(e)){return}var g={columns:this.getTableData(e)};e.popup({extraData:g,handler:"onDatabaseTableValidateAndShowPopup"})};b.prototype.cmdSaveMigration=function(f){var e=d(f.currentTarget);d.oc.stripeLoadIndicator.show();e.request("onDatabaseTableMigrationApply").always(d.oc.builder.indexController.hideStripeIndicatorProxy).done(this.proxy(this.saveMigrationDone))};b.prototype.cmdDeleteTable=function(f){var e=d(f.currentTarget);d.oc.confirm(e.data("confirm"),this.proxy(this.deleteConfirmed))};b.prototype.cmdUnModifyForm=function(){var e=this.getMasterTabsActivePane();this.unmodifyTab(e)};b.prototype.cmdAddTimestamps=function(g){var e=d(g.currentTarget),f=this.addTimeStampColumns(e,["created_at","updated_at"]);if(!f){alert(e.closest("form").attr("data-lang-timestamps-exist"))}};b.prototype.cmdAddSoftDelete=function(g){var e=d(g.currentTarget),f=this.addTimeStampColumns(e,["deleted_at"]);if(!f){alert(e.closest("form").attr("data-lang-soft-deleting-exist"))}};b.prototype.onTableCellChanged=function(h,g,i,j){var e=d(h.target);if(e.data("alias")!="columns"){return}if(e.closest("form").data("entity")!="database"){return}var f={};if(g=="auto_increment"&&i){f.unsigned=1;f.primary_key=1}if(g=="unsigned"&&!i){f.auto_increment=0}if(g=="primary_key"&&i){f.allow_null=0}if(g=="allow_null"&&i){f.primary_key=0}if(g=="primary_key"&&!i){f.auto_increment=0}e.table("setRowValues",j,f)};b.prototype.onTableLoaded=function(){d(document).trigger("render");var h=this.getMasterTabsActivePane(),e=h.find("form"),f=h.find("div[data-control=table] div.toolbar"),g=d('<a class="btn oc-icon-clock-o builder-custom-table-button" data-builder-command="databaseTable:cmdAddTimestamps"></a>');g.text(e.attr("data-lang-add-timestamps"));f.append(g);g=d('<a class="btn oc-icon-refresh builder-custom-table-button" data-builder-command="databaseTable:cmdAddSoftDelete"></a>');g.text(e.attr("data-lang-add-soft-delete"));f.append(g)};b.prototype.registerHandlers=function(){this.indexController.$masterTabs.on("oc.tableCellChanged",this.proxy(this.onTableCellChanged))};b.prototype.validateTable=function(e){var f=this.getTableControlObject(e);f.unfocusTable();return f.validate()};b.prototype.getTableData=function(e){var f=this.getTableControlObject(e);return f.dataSource.getAllData()};b.prototype.getTableControlObject=function(e){var f=e.closest("form"),g=f.find("[data-control=table]"),h=g.data("oc.table");if(!h){throw new Error("Table object is not found on the database table tab")}return h};b.prototype.saveMigrationDone=function(e){if(e.builderResponseData===undefined){throw new Error("Invalid response data")}d("#builderTableMigrationPopup").trigger("close.oc.popup");var f=this.getMasterTabsActivePane(),g=this.getMasterTabsObject();if(e.builderResponseData.operation!="delete"){f.find("input[name=table_name]").val(e.builderResponseData.builderObjectName);this.updateMasterTabIdAndTitle(f,e.builderResponseData);this.unhideFormDeleteButton(f);this.getTableList().fileList("markActive",e.builderResponseData.tabId);this.getIndexController().unchangeTab(f)}else{this.forceCloseTab(f)}d.oc.builder.dataRegistry.clearCache(e.builderResponseData.pluginCode,"model-columns")};b.prototype.getTableList=function(){return d("#layout-side-panel form[data-content-id=database] [data-control=filelist]")};b.prototype.deleteConfirmed=function(){var e=this.getMasterTabsActivePane();e.find("form").popup({handler:"onDatabaseTableShowDeletePopup"})};b.prototype.getColumnNames=function(f){var i=this.getTableControlObject(f);i.unfocusTable();var h=this.getTableData(f),e=[];for(var g in h){if(h[g].name!==undefined){e.push(d.trim(h[g].name))}}return e};b.prototype.addTimeStampColumns=function(e,g){var j=this.getColumnNames(e),i=false;for(var f in g){var h=g[f];if(d.inArray(h,j)==-1){this.addTimeStampColumn(e,h);i=true}}if(i){e.trigger("change")}return i};b.prototype.addTimeStampColumn=function(e,g){var i=this.getTableControlObject(e),f=this.getTableData(e),h={name:g,type:"timestamp","default":null,allow_null:true};i.addRecord("bottom",true);i.setRowValues(f.length-1,h);i.addRecord("bottom",false);i.deleteRecord()};d.oc.builder.entityControllers.databaseTable=b}(window.jQuery);