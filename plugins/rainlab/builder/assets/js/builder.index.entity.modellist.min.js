+function(d){if(d.oc.builder===undefined){d.oc.builder={}}if(d.oc.builder.entityControllers===undefined){d.oc.builder.entityControllers={}}var c=d.oc.builder.entityControllers.base,b=c.prototype;var a=function(e){this.cachedModelFieldsPromises={};c.call(this,"modelList",e)};a.prototype=Object.create(b);a.prototype.constructor=a;a.prototype.registerHandlers=function(){d(document).on("autocompleteitems.oc.table",'form[data-sub-entity="model-list"] [data-control=table]',this.proxy(this.onAutocompleteItems))};a.prototype.cmdCreateList=function(g){var f=d(g.currentTarget),h={model_class:f.data("modelClass")};var e=this.indexController.openOrLoadMasterTab(f,"onModelListCreateOrOpen",this.newTabId(),h);if(e!==false){e.done(this.proxy(this.onListLoaded,this))}};a.prototype.cmdSaveList=function(g){var e=d(g.currentTarget),f=e.closest("form");if(!this.validateTable(e)){return}e.request("onModelListSave",{data:{columns:this.getTableData(e)}}).done(this.proxy(this.saveListDone))};a.prototype.cmdOpenList=function(g){var h=d(g.currentTarget).data("list"),f=d(g.currentTarget).data("modelClass");var e=this.indexController.openOrLoadMasterTab(d(g.target),"onModelListCreateOrOpen",this.makeTabId(f+"-"+h),{file_name:h,model_class:f});if(e!==false){e.done(this.proxy(this.onListLoaded,this))}};a.prototype.cmdDeleteList=function(f){var e=d(f.currentTarget);d.oc.confirm(e.data("confirm"),this.proxy(this.deleteConfirmed))};a.prototype.cmdAddDatabaseColumns=function(f){var e=d(f.currentTarget);d.oc.stripeLoadIndicator.show();e.request("onModelListLoadDatabaseColumns").done(this.proxy(this.databaseColumnsLoaded)).always(d.oc.builder.indexController.hideStripeIndicatorProxy)};a.prototype.saveListDone=function(e){if(e.builderResponseData===undefined){throw new Error("Invalid response data")}var f=this.getMasterTabsActivePane();f.find("input[name=file_name]").val(e.builderResponseData.builderObjectName);this.updateMasterTabIdAndTitle(f,e.builderResponseData);this.unhideFormDeleteButton(f);this.getModelList().fileList("markActive",e.builderResponseData.tabId);this.getIndexController().unchangeTab(f);this.updateDataRegistry(e)};a.prototype.deleteConfirmed=function(){var f=this.getMasterTabsActivePane(),e=f.find("form");d.oc.stripeLoadIndicator.show();e.request("onModelListDelete").always(d.oc.builder.indexController.hideStripeIndicatorProxy).done(this.proxy(this.deleteDone))};a.prototype.deleteDone=function(e){var f=this.getMasterTabsActivePane();this.getIndexController().unchangeTab(f);this.forceCloseTab(f);this.updateDataRegistry(e)};a.prototype.getTableControlObject=function(e){var f=e.closest("form"),g=f.find("[data-control=table]"),h=g.data("oc.table");if(!h){throw new Error("Table object is not found on the model list tab")}return h};a.prototype.getModelList=function(){return d("#layout-side-panel form[data-content-id=models] [data-control=filelist]")};a.prototype.validateTable=function(e){var f=this.getTableControlObject(e);f.unfocusTable();return f.validate()};a.prototype.getTableData=function(e){var f=this.getTableControlObject(e);return f.dataSource.getAllData()};a.prototype.loadModelFields=function(h,i){var f=d(h).closest("form"),e=f.find("input[name=model_class]").val(),g=f.data("oc.model-field-cache");if(g!==undefined){i(g);return}if(this.cachedModelFieldsPromises[e]===undefined){this.cachedModelFieldsPromises[e]=f.request("onModelFormGetModelFields",{data:{as_plain_list:1}})}if(i===undefined){return}this.cachedModelFieldsPromises[e].done(function(j){f.data("oc.model-field-cache",j.responseData.options);i(j.responseData.options)})};a.prototype.updateDataRegistry=function(f){if(f.builderResponseData.registryData!==undefined){var e=f.builderResponseData.registryData;d.oc.builder.dataRegistry.set(e.pluginCode,"model-lists",e.modelClass,e.lists);d.oc.builder.dataRegistry.clearCache(e.pluginCode,"plugin-lists")}};a.prototype.databaseColumnsLoaded=function(j){if(!d.isArray(j.responseData.columns)){alert("Invalid server response")}var m=this.getMasterTabsActivePane(),e=m.find("form"),l=this.getColumnNames(e),k=false;for(var f in j.responseData.columns){var h=j.responseData.columns[f],g=this.mapType(h.type);if(d.inArray(h.name,l)!==-1){continue}this.addColumn(e,h.name,g);k=true}if(!k){alert(e.attr("data-lang-all-database-columns-exist"))}else{e.trigger("change")}};a.prototype.mapType=function(e){switch(e){case"integer":return"number";case"timestamp":return"datetime";default:return"text"}};a.prototype.addColumn=function(e,h,g){var j=this.getTableControlObject(e),f=this.getTableData(e),i={field:h,label:h,type:g};j.addRecord("bottom",true);j.setRowValues(f.length-1,i);j.addRecord("bottom",false);j.deleteRecord()};a.prototype.getColumnNames=function(f){var i=this.getTableControlObject(f);i.unfocusTable();var h=this.getTableData(f),e=[];for(var g in h){if(h[g].field!==undefined){e.push(d.trim(h[g].field))}}return e};a.prototype.onAutocompleteItems=function(e,f){if(f.columnConfiguration.fillFrom==="model-fields"){e.preventDefault();this.loadModelFields(e.target,f.callback);return false}};a.prototype.onListLoaded=function(){d(document).trigger("render");var h=this.getMasterTabsActivePane(),e=h.find("form"),f=h.find("div[data-control=table] div.toolbar"),g=d('<a class="btn oc-icon-magic builder-custom-table-button" data-builder-command="modelList:cmdAddDatabaseColumns"></a>');g.text(e.attr("data-lang-add-database-columns"));f.append(g)};d.oc.builder.entityControllers.modelList=a}(window.jQuery);