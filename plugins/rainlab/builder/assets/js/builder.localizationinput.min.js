+function(d){if(d.oc.builder===undefined){d.oc.builder={}}var b=d.oc.foundation.base,a=b.prototype;var c=function(e,g,f){this.input=e;this.form=g;this.options=d.extend({},c.DEFAULTS,f);this.disposed=false;this.initialized=false;this.newStringPopupMarkup=null;b.call(this);this.init()};c.prototype=Object.create(a);c.prototype.constructor=c;c.prototype.dispose=function(){this.unregisterHandlers();this.form=null;this.options.beforePopupShowCallback=null;this.options.afterPopupHideCallback=null;this.options=null;this.disposed=true;this.newStringPopupMarkup=null;if(this.initialized){d(this.input).autocomplete("destroy")}d(this.input).removeData("localization-input");this.input=null;a.dispose.call(this)};c.prototype.init=function(){if(!this.options.plugin){throw new Error("The options.plugin value should be set in the localization input object.")}var e=d(this.input);e.data("localization-input",this);e.attr("data-builder-localization-input","true");e.attr("data-builder-localization-plugin",this.options.plugin);this.getContainer().addClass("localization-input-container");this.registerHandlers();this.loadDataAndBuild()};c.prototype.buildAddLink=function(){var f=this.getContainer();if(f.find("a.localization-trigger").length>0){return}var e=document.createElement("a");e.setAttribute("class","oc-icon-plus localization-trigger");e.setAttribute("href","#");var g=f.position();d(e).css({top:g.top+4,right:7});f.append(e)};c.prototype.loadDataAndBuild=function(){this.showLoadingIndicator();var e=d.oc.builder.dataRegistry.get(this.form,this.options.plugin,"localization",null,this.proxy(this.dataLoaded)),f=this;if(e){e.always(function(){f.hideLoadingIndicator()})}};c.prototype.reload=function(){d.oc.builder.dataRegistry.get(this.form,this.options.plugin,"localization",null,this.proxy(this.dataLoaded))};c.prototype.dataLoaded=function(g){if(this.disposed){return}var h=d(this.input),f=h.data("autocomplete");if(!f){this.hideLoadingIndicator();var e={source:this.preprocessData(g),matchWidth:true};e=d.extend(e,this.options.autocompleteOptions);d(this.input).autocomplete(e);this.initialized=true}else{f.source=this.preprocessData(g)}};c.prototype.preprocessData=function(g){var e=d.extend({},g);for(var f in e){e[f]=f+" - "+e[f]}return e};c.prototype.getContainer=function(){return d(this.input).closest(".autocomplete-container")};c.prototype.showLoadingIndicator=function(){var e=this.getContainer();e.addClass("loading-indicator-container size-small");e.loadIndicator()};c.prototype.hideLoadingIndicator=function(){var e=this.getContainer();e.loadIndicator("hide");e.loadIndicator("destroy");e.removeClass("loading-indicator-container")};c.prototype.loadAndShowPopup=function(){if(this.newStringPopupMarkup===null){d.oc.stripeLoadIndicator.show();d(this.input).request("onLanguageLoadAddStringForm").done(this.proxy(this.popupMarkupLoaded)).always(function(){d.oc.stripeLoadIndicator.hide()})}else{this.showPopup()}};c.prototype.popupMarkupLoaded=function(e){this.newStringPopupMarkup=e.markup;this.showPopup()};c.prototype.showPopup=function(){var g=d(this.input);g.popup({content:this.newStringPopupMarkup});var e=g.data("oc.popup").$content,f=e.find("#language_string_key");d.oc.builder.dataRegistry.get(this.form,this.options.plugin,"localization","sections",function(h){f.autocomplete({source:h,matchWidth:true})});e.find("form").on("submit",this.proxy(this.onSubmitPopupForm))};c.prototype.stringCreated=function(e){if(e.localizationData===undefined||e.registryData===undefined){throw new Error("Invalid server response.")}var f=d(this.input);f.val(e.localizationData.key);d.oc.builder.dataRegistry.set(this.options.plugin,"localization",null,e.registryData.strings);d.oc.builder.dataRegistry.set(this.options.plugin,"localization","sections",e.registryData.sections);f.data("oc.popup").hide();f.trigger("change")};c.prototype.onSubmitPopupForm=function(f){var e=d(f.target);d.oc.stripeLoadIndicator.show();e.request("onLanguageCreateString",{data:{plugin_code:this.options.plugin}}).done(this.proxy(this.stringCreated)).always(function(){d.oc.stripeLoadIndicator.hide()});f.preventDefault();return false};c.prototype.onPopupHidden=function(g,f,e){d(e).find("#language_string_key").autocomplete("destroy");d(e).find("form").on("submit",this.proxy(this.onSubmitPopupForm));if(this.options.afterPopupHideCallback){this.options.afterPopupHideCallback()}};c.updatePluginInputs=function(g){var e=document.body.querySelectorAll('input[data-builder-localization-input][data-builder-localization-plugin="'+g+'"]');for(var f=e.length-1;f>=0;f--){d(e[f]).data("localization-input").reload()}};c.prototype.unregisterHandlers=function(){this.input.removeEventListener("focus",this.proxy(this.onInputFocus));this.getContainer().off("click","a.localization-trigger",this.proxy(this.onTriggerClick));d(this.input).off("hidden.oc.popup",this.proxy(this.onPopupHidden))};c.prototype.registerHandlers=function(){this.input.addEventListener("focus",this.proxy(this.onInputFocus));this.getContainer().on("click","a.localization-trigger",this.proxy(this.onTriggerClick));d(this.input).on("hidden.oc.popup",this.proxy(this.onPopupHidden))};c.prototype.onInputFocus=function(){this.buildAddLink()};c.prototype.onTriggerClick=function(e){if(this.options.beforePopupShowCallback){this.options.beforePopupShowCallback()}this.loadAndShowPopup();e.preventDefault();return false};c.DEFAULTS={plugin:null,autocompleteOptions:{},beforePopupShowCallback:null,afterPopupHideCallback:null};d.oc.builder.localizationInput=c}(window.jQuery);