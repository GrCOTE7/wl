+function(d){var b=d.oc.foundation.base,a=b.prototype;var c=function(){b.call(this);this.placeholderIdIndex=0;this.updateControlBodyTimer=null;this.init()};c.prototype=Object.create(a);c.prototype.constructor=c;c.prototype.init=function(){this.registerHandlers()};c.prototype.registerHandlers=function(){document.addEventListener("dragstart",this.proxy(this.onDragStart));document.addEventListener("dragover",this.proxy(this.onDragOver));document.addEventListener("dragenter",this.proxy(this.onDragEnter));document.addEventListener("dragleave",this.proxy(this.onDragLeave));document.addEventListener("drop",this.proxy(this.onDragDrop),false);d(document).on("change",".builder-control-list > li.control",this.proxy(this.onControlChange));d(document).on("click",".builder-control-list > li.control div[data-builder-remove-control]",this.proxy(this.onRemoveControl));d(document).on("click",".builder-control-list > li.placeholder",this.proxy(this.onPlaceholderClick));d(document).on("showing.oc.inspector",".builder-control-list > li.control",this.proxy(this.onInspectorShowing));d(document).on("livechange",".builder-control-list > li.control",this.proxy(this.onControlLiveChange));d(document).on("autocompleteitems.oc.inspector",".builder-control-list > li.control",this.proxy(this.onAutocompleteItems));d(document).on("dropdownoptions.oc.inspector",".builder-control-list > li.control",this.proxy(this.onDropdownOptions))};c.prototype.getControlId=function(e){if(e.hasAttribute("data-builder-control-id")){return e.getAttribute("data-builder-control-id")}this.placeholderIdIndex++;e.setAttribute("data-builder-control-id",this.placeholderIdIndex);return this.placeholderIdIndex};c.prototype.getControlProperties=function(e){var h=e.children;for(var g=h.length-1;g>=0;g--){var f=h[g];if(f.tagName==="INPUT"&&f.hasAttribute("data-inspector-values")){return d.parseJSON(f.value)}}throw new Error("Inspector values element is not found in control.")};c.prototype.setControlProperties=function(e,f){var h=JSON.stringify(f),g=e.querySelector("[data-inspector-values]");g.value=h};c.prototype.loadModelFields=function(g,i){var f=d(this.findForm(g)),h=d.oc.builder.indexController.getFormPluginCode(f),e=f.find("input[name=model_class]").val();d.oc.builder.dataRegistry.get(f,h,"model-columns",e,function(j){i({options:d.oc.builder.indexController.dataToInspectorArray(j)})})};c.prototype.getContainerFieldNames=function(k,l){var h=this.findRootControlWrapper(k),j=d.oc.builder.formbuilder.domToPropertyJson.getAllControlNames(h),f=[];f.push({title:"---",value:""});for(var g=0,e=j.length;g<e;g++){f.push({title:j[g],value:j[g]})}l({options:f})};c.prototype.fieldNameExistsInContainer=function(f,k){var e=f.querySelectorAll("li.control[data-inspectable] input[data-inspector-values]");for(var h=e.length-1;h>=0;h--){var j=String(e[h].value);if(j.length===0){continue}var g=d.parseJSON(j);if(g["oc.fieldName"]==k){return true}}return false};c.prototype.reflow=function(m,l){if(!m&&!l){throw new Error("Invalid call of the reflow method. Either li or list parameter should be not empty.")}var g=l?l:m.parentNode,h=g.children,j=null;for(var e=0,f=h.length;e<f;e++){var n=h[e],k=n.getAttribute("data-builder-span");if(d.oc.foundation.element.hasClass(n,"clear-row")){continue}if(k=="auto"){d.oc.foundation.element.removeClass(n,"span-left");d.oc.foundation.element.removeClass(n,"span-full");d.oc.foundation.element.removeClass(n,"span-right");if(j=="left"){d.oc.foundation.element.addClass(n,"span-right");j="right"}else{if(!d.oc.foundation.element.hasClass(n,"placeholder")){d.oc.foundation.element.addClass(n,"span-left")}else{d.oc.foundation.element.addClass(n,"span-full")}j="left"}}else{d.oc.foundation.element.removeClass(n,"span-left");d.oc.foundation.element.removeClass(n,"span-full");d.oc.foundation.element.removeClass(n,"span-right");d.oc.foundation.element.addClass(n,"span-"+k);j=k}}};c.prototype.setControlSpanFromProperties=function(e,f){if(f.span===undefined){return}e.setAttribute("data-builder-span",f.span);this.reflow(e)};c.prototype.appendClearRowElement=function(e){e.insertAdjacentHTML("afterend",'<li class="clear-row"></li>')};c.prototype.patchControlSpan=function(e,g){e.setAttribute("data-builder-span",g);var f=this.getControlProperties(e);f.span=g;this.setControlProperties(e,f)};c.prototype.targetIsPlaceholder=function(e){if(!e.target.getAttribute){return false}return e.target.getAttribute("data-builder-placeholder")};c.prototype.dataTransferContains=function(f,e){if(f.dataTransfer.types.indexOf!==undefined){return f.dataTransfer.types.indexOf(e)>=0}return f.dataTransfer.types.contains(e)};c.prototype.sourceIsContainer=function(e){return this.dataTransferContains(e,"builder/source/container")};c.prototype.startDragFromContainer=function(e){e.dataTransfer.effectAllowed="move";var f=this.getControlId(e.target);e.dataTransfer.setData("builder/source/container","true");e.dataTransfer.setData("builder/control/id",f);e.dataTransfer.setData(f,f)};c.prototype.dropTargetIsChildOf=function(g,e){var f=g;while(f){if(this.elementIsControl(f)&&this.dataTransferContains(e,this.getControlId(f))){return true}f=f.parentNode}return false};c.prototype.dropFromContainerToPlaceholderOrControl=function(i,l){var e=l?l:i.target;d.oc.foundation.event.stop(i);this.stopHighlightingTargets(e);var k=i.dataTransfer.getData("builder/control/id"),f=document.body.querySelector('li[data-builder-control-id="'+k+'"]');if(!f){return}var h=f.parentNode===e.parentNode,j=f.parentNode,g=d(f).next();e.parentNode.insertBefore(f,e);this.appendClearRowElement(f);if(g.hasClass("clear-row")){g.remove()}if(!d.oc.foundation.element.hasClass(f,"inspector-open")){this.patchControlSpan(f,"auto")}this.reflow(e);if(!h){this.reflow(null,j)}d(e).closest("form").trigger("change")};c.prototype.elementContainsPoint=function(e,f){var h=d.oc.foundation.element.absolutePosition(f),g=h.left+f.offsetWidth,i=h.top+f.offsetHeight;return e.x>=h.left&&e.x<=g&&e.y>=h.top&&e.y<=i};c.prototype.stopHighlightingTargets=function(j,h){var g=this.findRootControlWrapper(j),e=g.querySelectorAll("li.control.drag-over");for(var f=e.length-1;f>=0;f--){if(!h||j!==e[f]){d.oc.foundation.element.removeClass(e[f],"drag-over")}}};c.prototype.startUpdateControlBody=function(f){this.clearUpdateControlBodyTimer();var e=this;this.updateControlBodyTimer=window.setTimeout(function(){e.updateControlBody(f)},300)};c.prototype.clearUpdateControlBodyTimer=function(){if(this.updateControlBodyTimer===null){return}clearTimeout(this.updateControlBodyTimer);this.updateControlBodyTimer=null};c.prototype.updateControlBody=function(k){var l=document.body.querySelector('li[data-builder-control-id="'+k+'"]');if(!l){return}this.clearUpdateControlBodyTimer();var h=this.findRootControlWrapper(l),e=h.querySelectorAll("li.control.updating-control");for(var g=e.length-1;g>=0;g--){d.oc.foundation.element.removeClass(e[g],"updating-control")}d.oc.foundation.element.addClass(l,"updating-control");var m=l.getAttribute("data-control-type"),f=this.getControlProperties(l),j={controlType:m,controlId:k,properties:f};d(l).request("onModelFormRenderControlBody",{data:j}).done(this.proxy(this.controlBodyMarkupLoaded)).always(function(){d.oc.foundation.element.removeClass(l,"updating-control")})};c.prototype.controlBodyMarkupLoaded=function(f){var e=document.body.querySelector('li[data-builder-control-id="'+f.controlId+'"]');if(!e){return}var g=e.querySelector(".control-wrapper");g.innerHTML=f.markup};c.prototype.generateFieldName=function(i,g){var f=this.findControlContainer(g);if(!f){throw new Error("Cannot find control container for a placeholder.")}var e=1,h=i+e;while(this.fieldNameExistsInContainer(f,h)){e++;h=i+e}return h};c.prototype.addControlToPlaceholder=function(i,k,h,e){if(!e){var g=d(i.outerHTML);g.removeAttr("data-builder-control-id");g.removeClass("control-palette-open");i.insertAdjacentHTML("afterend",g.get(0).outerHTML)}this.appendClearRowElement(i);d.oc.foundation.element.removeClass(i,"placeholder");d.oc.foundation.element.addClass(i,"loading-control");d.oc.foundation.element.removeClass(i,"control-palette-open");i.innerHTML="";i.removeAttribute("data-builder-placeholder");var j=this.generateFieldName(k,i);var f={controlType:k,controlId:this.getControlId(i),properties:{label:h,span:"auto","oc.fieldName":j}};this.reflow(i);return d(i).request("onModelFormRenderControlWrapper",{data:f}).done(this.proxy(this.controlWrapperMarkupLoaded))};c.prototype.controlWrapperMarkupLoaded=function(e){var f=document.body.querySelector('li[data-builder-control-id="'+e.controlId+'"]');if(!f){return}f.setAttribute("draggable",true);f.setAttribute("data-inspectable",true);f.setAttribute("data-control-type",e.type);f.setAttribute("data-inspector-title",e.controlTitle);f.setAttribute("data-inspector-description",e.description);f.innerHTML=e.markup;d.oc.foundation.element.removeClass(f,"loading-control")};c.prototype.displayControlPaletteForPlaceholder=function(e){d.oc.builder.formbuilder.controlPalette.loadControlPalette(e,this.getControlId(e))};c.prototype.addControlFromControlPalette=function(e,h,f){var g=document.body.querySelector('li[data-builder-control-id="'+e+'"]');if(!g){return}return this.addControlToPlaceholder(g,h,f)};c.prototype.removeControl=function(g){if(g.hasClass("inspector-open")){var e=this.findInspectorContainer(g);d.oc.foundation.controlUtils.disposeControls(e.get(0))}var f=g.next();g.remove();this.reflow(f.get(0));f.trigger("change")};c.prototype.findControlContainer=function(e){var f=e;while(f){if(f.hasAttribute&&f.hasAttribute("data-control-container")){return f}f=f.parentNode}return null};c.prototype.findForm=function(e){var f=e;while(f){if(f.tagName==="FORM"){return f}f=f.parentNode}return null};c.prototype.findControlList=function(e){var f=e;while(f){if(f.hasAttribute("data-control-list")){return f}f=f.parentNode}throw new Error("Cannot find control list for an element.")};c.prototype.findPlaceholder=function(e){var h=e.children;for(var g=h.length-1;g>=0;g--){var f=h[g];if(f.tagName==="LI"&&d.oc.foundation.element.hasClass(f,"placeholder")){return f}}throw new Error("Cannot find placeholder in a control list.")};c.prototype.findRootControlWrapper=function(f){var e=f;while(e){if(e.hasAttribute("data-root-control-wrapper")){return e}e=e.parentNode}throw new Error("Cannot find root control wrapper.")};c.prototype.findInspectorContainer=function(f){var e=f.closest("[data-inspector-container]");return e.find(".inspector-container")};c.prototype.elementIsControl=function(e){return e.tagName==="LI"&&e.hasAttribute("data-control-type")&&d.oc.foundation.element.hasClass(e,"control")};c.prototype.getClosestControl=function(e){var f=e;while(f){if(this.elementIsControl(f)){return f}f=f.parentNode}return null};c.prototype.onDragStart=function(e){if(this.elementIsControl(e.target)){this.startDragFromContainer(e);return}};c.prototype.onDragOver=function(h){var g=h.target;if(h.target.tagName!=="LI"){g=this.getClosestControl(h.target)}if(!g||g.tagName!="LI"){return}var e=this.sourceIsContainer(h),f=this.elementIsControl(g);if((this.targetIsPlaceholder(h)||f)&&e){if(e&&f&&this.dropTargetIsChildOf(g,h)){return false}d.oc.foundation.event.stop(h);h.dataTransfer.dropEffect="move";return}};c.prototype.onDragEnter=function(h){var g=h.target;if(h.target.tagName!=="LI"){g=this.getClosestControl(h.target)}if(!g||g.tagName!="LI"){return}var e=this.sourceIsContainer(h);if(this.targetIsPlaceholder(h)&&e){if(e&&this.dropTargetIsChildOf(h.target,h)){this.stopHighlightingTargets(h.target,true);return}d.oc.foundation.element.addClass(h.target,"drag-over");return}var f=this.elementIsControl(g);if(f&&e){if(e&&f&&this.dropTargetIsChildOf(g,h)){this.stopHighlightingTargets(g,true);return}d.oc.foundation.element.addClass(g,"drag-over");this.stopHighlightingTargets(g,true);return}};c.prototype.onDragLeave=function(f){var e=f.target;if(f.target.tagName!=="LI"){e=this.getClosestControl(f.target)}if(!e||e.tagName!="LI"){return}if(this.targetIsPlaceholder(f)&&this.sourceIsContainer(f)){this.stopHighlightingTargets(f.target);return}if(this.elementIsControl(e)&&this.sourceIsContainer(f)){var g=d.oc.foundation.event.pageCoordinates(f);if(!this.elementContainsPoint(g,e)){this.stopHighlightingTargets(e)}}};c.prototype.onDragDrop=function(h){var g=h.target;if(h.target.tagName!=="LI"){g=this.getClosestControl(h.target)}if(!g||g.tagName!="LI"){return}var f=this.elementIsControl(g),e=this.sourceIsContainer(h);if((f||this.targetIsPlaceholder(h))&&e){this.stopHighlightingTargets(g);if(this.dropTargetIsChildOf(g,h)){return}this.dropFromContainerToPlaceholderOrControl(h,g);return}};c.prototype.onControlChange=function(g){var e=g.currentTarget,f=this.getControlProperties(e);this.setControlSpanFromProperties(e,f);this.updateControlBody(this.getControlId(e));g.stopPropagation();return false};c.prototype.onControlLiveChange=function(g){d(this.findForm(g.currentTarget)).trigger("change");var f=g.currentTarget,e=this.getControlProperties(f);this.setControlSpanFromProperties(f,e);this.startUpdateControlBody(this.getControlId(f));g.stopPropagation();return false};c.prototype.onAutocompleteItems=function(e,f){if(f.propertyDefinition.fillFrom==="model-fields"){e.preventDefault();this.loadModelFields(e.target,f.callback)}};c.prototype.onDropdownOptions=function(e,f){if(f.propertyDefinition.fillFrom==="form-controls"){this.getContainerFieldNames(e.target,f.callback);e.preventDefault()}};c.prototype.onRemoveControl=function(e){this.removeControl(d(e.target).closest("li.control"));e.preventDefault();e.stopPropagation();return false};c.prototype.onInspectorShowing=function(e){if(d(e.target).find("input[data-non-inspectable-control]").length>0){e.preventDefault();return false}};c.prototype.onPlaceholderClick=function(e){this.displayControlPaletteForPlaceholder(e.target);e.stopPropagation();e.preventDefault();return false};d(document).ready(function(){d.oc.builder.formbuilder.controller=new c()})}(window.jQuery);