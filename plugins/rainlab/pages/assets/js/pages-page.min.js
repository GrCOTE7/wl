+function(d){var c=d.oc.foundation.base,b=c.prototype;var a=function(){c.call(this);this.init()};a.prototype=Object.create(b);a.prototype.constructor=a;a.prototype.init=function(){this.$masterTabs=d("#pages-master-tabs");this.$sidePanel=d("#pages-side-panel");this.$pageTree=d("[data-control=treeview]",this.$sidePanel);this.masterTabsObj=this.$masterTabs.data("oc.tab");this.snippetManager=new d.oc.pages.snippetManager(this.$masterTabs);this.registerHandlers()};a.prototype.registerHandlers=function(){d(document).on("open.oc.treeview","form.layout[data-content-id=pages]",this.proxy(this.onSidebarItemClick));d(document).on("open.oc.list",this.$sidePanel,this.proxy(this.onSidebarItemClick));this.$masterTabs.on("shown.bs.tab",this.proxy(this.onTabShown));this.$masterTabs.on("afterAllClosed.oc.tab",this.proxy(this.onAllTabsClosed));this.$masterTabs.on("closed.oc.tab",this.proxy(this.onTabClosed));d(document).on("ajaxError","#pages-master-tabs form",this.proxy(this.onAjaxError));d(document).on("ajaxSuccess","#pages-master-tabs form",this.proxy(this.onAjaxSuccess));d(document).on("oc.beforeRequest","#pages-master-tabs form[data-object-type=content]",this.proxy(this.onBeforeSaveContent));d(document).on("change",'#pages-master-tabs form[data-object-type=page] select[name="viewBag[layout]"]',this.proxy(this.onLayoutChanged));d(document).on("click","#pages-side-panel form [data-control=create-object], #pages-side-panel form [data-control=create-template]",this.proxy(this.onCreateObject));d(document).on("submenu.oc.treeview","form.layout[data-content-id=pages]",this.proxy(this.onSidebarSubmenuItemClick));d(document).on("click","#pages-side-panel form button[data-control=delete-object], #pages-side-panel form button[data-control=delete-template]",this.proxy(this.onDeleteObject));this.$masterTabs.on("initTab.oc.tab",this.proxy(this.onInitTab));d(document).on("oc.beforeRequest","#pages-master-tabs form[data-object-type=menu]",this.proxy(this.onSaveMenu))};a.prototype.handleMtimeMismatch=function(h){var g=d(h);g.popup({handler:"onOpenConcurrencyResolveForm"});var e=g.data("oc.popup"),f=this;d(e.$container).on("click","button[data-action=reload]",function(){e.hide();f.reloadForm(g)});d(e.$container).on("click","button[data-action=save]",function(){e.hide();d("input[name=objectForceSave]",g).val(1);d("a[data-request=onSave]",g).trigger("click");d("input[name=objectForceSave]",g).val(0)})};a.prototype.reloadForm=function(f){var i={type:d("[name=objectType]",f).val(),theme:d("[name=theme]",f).val(),path:d("[name=objectPath]",f).val(),},g=i.type+"-"+i.theme+"-"+i.path,h=this.masterTabsObj.findByIdentifier(g),e=this;d.oc.stripeLoadIndicator.show();f.request("onOpen",{data:i}).done(function(j){d.oc.stripeLoadIndicator.hide();e.$masterTabs.ocTab("updateTab",h,j.tabTitle,j.tab);e.$masterTabs.ocTab("unmodifyTab",h);e.updateModifiedCounter()}).always(function(){d.oc.stripeLoadIndicator.hide()})};a.prototype.updateModifiedCounter=function(){var e={page:{menu:"pages",count:0},menu:{menu:"menus",count:0},content:{menu:"content",count:0},};d("> div.tab-content > div.tab-pane[data-modified]",this.$masterTabs).each(function(){var f=d("> form > input[name=objectType]",this).val();e[f].count++});d.each(e,function(f,g){d.oc.sideNav.setCounter("pages/"+g.menu,g.count)})};a.prototype.onTabShown=function(h){var g=d(h.target).closest("[data-control=tab]");if(g.attr("id")=="pages-master-tabs"){var f=d(h.target).closest("li").attr("data-tab-id"),i=d(h.target).attr("title");if(i){this.setPageTitle(i)}this.$pageTree.treeView("markActive",f);d("[data-control=filelist]",this.$sidePanel).fileList("markActive",f);d(window).trigger("resize")}else{if(g.hasClass("secondary")){}}};a.prototype.onAllTabsClosed=function(){this.$pageTree.treeView("markActive",null);d("[data-control=filelist]",this.$sidePanel).fileList("markActive",null);this.setPageTitle("")};a.prototype.onTabClosed=function(){this.updateModifiedCounter()};a.prototype.onAjaxError=function(h,e,g,i,f){if(e.handler!="onSave"){return}if(f.responseText=="mtime-mismatch"){h.preventDefault();this.handleMtimeMismatch(h.target)}};a.prototype.onAjaxSuccess=function(j,i,k){var g=d(j.currentTarget),e=g.closest(".tab-pane");if(k.objectPath!==undefined){d("input[name=objectPath]",g).val(k.objectPath);d("input[name=objectMtime]",g).val(k.objectMtime);d("[data-control=delete-button]",g).removeClass("hide");d("[data-control=preview-button]",g).removeClass("hide");if(k.pageUrl!==undefined){d("[data-control=preview-button]",g).attr("href",k.pageUrl)}}if(k.tabTitle!==undefined){this.$masterTabs.ocTab("updateTitle",e,k.tabTitle);this.setPageTitle(k.tabTitle)}var h=d("input[name=objectType]",g).val()+"-"+d("input[name=theme]",g).val()+"-"+d("input[name=objectPath]",g).val();this.$masterTabs.ocTab("updateIdentifier",e,h);this.$pageTree.treeView("markActive",h);d("[data-control=filelist]",this.$sidePanel).fileList("markActive",h);var f=d("input[name=objectType]",g).val();if(f.length>0&&i.handler=="onSave"){this.updateObjectList(f)}if(i.handler=="onSave"&&(!k.X_OCTOBER_ERROR_FIELDS&&!k.X_OCTOBER_ERROR_MESSAGE)){g.trigger("unchange.oc.changeMonitor")}};a.prototype.onBeforeSaveContent=function(i,h){var g=i.currentTarget,f=d(g).closest(".tab-pane");this.updateContentEditorMode(f,false)};a.prototype.setPageTitle=function(e){d.oc.layout.setPageTitle(e.length?(e+" | "):e)};a.prototype.updateObjectList=function(e){var g=d("form[data-object-type="+e+"]",this.$sidePanel),h=e+"List",f=this;d.oc.stripeLoadIndicator.show();g.request(h+"::onUpdate",{complete:function(i){d("button[data-control=delete-object], button[data-control=delete-template]",g).trigger("oc.triggerOn.update")}}).always(function(){d.oc.stripeLoadIndicator.hide()})};a.prototype.closeTabs=function(g,f){var e=this;d.each(g.deletedObjects,function(){var h=f+"-"+g.theme+"-"+this,i=e.masterTabsObj.findByIdentifier(h);d(i).trigger("close.oc.tab",[{force:true}])})};a.prototype.onSidebarItemClick=function(l){var h=this,g=d(l.relatedTarget),f=g.closest("form"),k=d("input[name=theme]",f).val(),j={type:f.data("object-type"),theme:k,path:g.data("item-path")},i=j.type+"-"+j.theme+"-"+j.path;if(g.data("type")=="snippet"){this.snippetManager.onSidebarSnippetClick(g);return}if(this.masterTabsObj.goTo(i)){return false}d.oc.stripeLoadIndicator.show();f.request("onOpen",{data:j}).done(function(e){h.$masterTabs.ocTab("addTab",e.tabTitle,e.tab,i,f.data("type-icon"))}).always(function(){d.oc.stripeLoadIndicator.hide()});return false};a.prototype.onCreateObject=function(l){var g=this,k=d(l.target),f=k.closest("form"),j=k.data("parent")!==undefined?k.data("parent"):null,i=f.data("object-type")?f.data("object-type"):f.data("template-type"),h=i+Math.random();d.oc.stripeLoadIndicator.show();f.request("onCreateObject",{data:{type:i,parent:j}}).done(function(e){g.$masterTabs.ocTab("addTab",e.tabTitle,e.tab,h,f.data("type-icon")+" new-template");d("#layout-side-panel").trigger("close.oc.sidePanel");g.setPageTitle(e.tabTitle)}).always(function(){d.oc.stripeLoadIndicator.hide()});l.stopPropagation();return false};a.prototype.onSidebarSubmenuItemClick=function(f){if(d(f.clickEvent.target).data("control")=="create-object"){this.onCreateObject(f.clickEvent)}return false};a.prototype.onDeleteObject=function(j){var i=d(j.target),h=i.closest("form"),f=h.data("object-type"),g=this;if(!confirm(i.data("confirmation"))){return}h.request("onDeleteObjects",{data:{type:f},success:function(e){d.each(e.deleted,function(l,n){var k=f+"-"+e.theme+"-"+n,m=g.masterTabsObj.findByIdentifier(k);g.$masterTabs.ocTab("closeTab",m,true)});if(e.error!==undefined&&d.type(e.error)==="string"&&e.error.length){d.oc.flashMsg({text:e.error,"class":"error"})}},complete:function(){g.updateObjectList(f)}});return false};a.prototype.onLayoutChanged=function(l){var g=this,h=d(l.target),f=h.closest("form"),j=f.closest(".tab-pane"),k={type:d("[name=objectType]",f).val(),theme:d("[name=theme]",f).val(),path:d("[name=objectPath]",f).val()},i=j.data("tab");f.changeMonitor("dispose");d.oc.stripeLoadIndicator.show();f.request("onUpdatePageLayout",{data:k}).done(function(e){g.$masterTabs.ocTab("updateTab",i,e.tabTitle,e.tab)}).always(function(){d.oc.stripeLoadIndicator.hide();d("form:first",j).changeMonitor().trigger("change")})};a.prototype.onInitTab=function(j,h){if(d(j.target).attr("id")!="pages-master-tabs"){return}var i=d('<a href="javascript:;" class="tab-collapse-icon tabless"><i class="icon-chevron-up"></i></a>'),o=d(".form-tabless-fields",h.pane),k=d(".control-tabs.secondary-tabs",h.pane),l=d(".control-tabs.primary-tabs",h.pane),g=k.length>0;k.addClass("secondary-content-tabs");o.append(i);if(!g){d(".primary-tabs").parent().removeClass("min-size")}i.click(function(){o.toggleClass("collapsed");if(typeof(localStorage)!=="undefined"){localStorage.ocPagesTablessCollapsed=o.hasClass("collapsed")?1:0}window.setTimeout(function(){d(window).trigger("oc.updateUi")},500);return false});var f=d('<a href="javascript:;" class="tab-collapse-icon primary"><i class="icon-chevron-down"></i></a>');if(l.length>0){k.append(f);f.click(function(){l.toggleClass("collapsed");k.toggleClass("primary-collapsed");d(window).trigger("oc.updateUi");if(typeof(localStorage)!=="undefined"){localStorage.ocPagesPrimaryCollapsed=l.hasClass("collapsed")?1:0}return false})}else{k.addClass("primary-collapsed")}if(typeof(localStorage)!=="undefined"){if(!d("a",h.tab).hasClass("new-template")&&localStorage.ocPagesTablessCollapsed==1){o.addClass("collapsed")}if(localStorage.ocPagesPrimaryCollapsed==1&&g){l.addClass("collapsed");k.addClass("primary-collapsed")}}var n=d("form",h.pane),m=this,o=d(".form-tabless-fields",h.pane);this.updateContentEditorMode(h.pane,true);n.on("changed.oc.changeMonitor",function(){o.trigger("modified.oc.tab");m.updateModifiedCounter()});n.on("unchanged.oc.changeMonitor",function(){o.trigger("unmodified.oc.tab");m.updateModifiedCounter()})};a.prototype.onSaveMenu=function(j,i){var h=j.currentTarget,f=[],k=d("div[data-control=treeview] > ol > li",h);var g=function(l){var e=[];d.each(l,function(){var n=d(this).data("menu-item");var m=d("> ol >li",this);if(m.length){n.items=g(m)}e.push(n)});return e};i.options.data.itemData=g(k)};a.prototype.updateContentEditorMode=function(l,g){if(d("[data-toolbar-type]",l).data("toolbar-type")!=="content"){return}var k=this.getContentExtension(l),j="html",f=d("[data-control=codeeditor]",l);if(k=="html"){k="htm"}if(g){d(l).data("prev-extension",k)}if(k=="htm"){d("[data-field-name=markup]",l).hide();d("[data-field-name=markup_html]",l).show();if(!g&&d(l).data("prev-extension")!="htm"){var i=f.codeEditor("getContent");d("div[data-control=richeditor]",l).richEditor("setContent",i)}}else{d("[data-field-name=markup]",l).show();d("[data-field-name=markup_html]",l).hide();if(!g&&d(l).data("prev-extension")=="htm"){var i=d("div[data-control=richeditor]",l).richEditor("getContent");f.codeEditor("setContent",i)}var h=d.oc.codeEditorExtensionModes;if(h[k]!==undefined){j=h[k]}var e=function(){window.setTimeout(function(){f.codeEditor("getEditorObject").getSession().setMode({path:"ace/mode/"+j})},200)};if(g){f.on("oc.codeEditorReady",e)}else{e()}}if(!g){d(l).data("prev-extension",k)}};a.prototype.getContentExtension=function(e){var h=d("input[name=fileName]",e),g=h.length?h.val():"",f=g.split(".");if(f.length>=2){return f.pop().toLowerCase()}return"htm"};d(document).ready(function(){d.oc.pagesPage=new a()})}(window.jQuery);